<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Use Prophetverse to optimize media budget allocation across channels for one or many time series.">

<title>Budget Optimization for Single and Multiple Time Series ‚Äì prophetverse</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../static/logo-removebg.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-f2b1ffb2c002503e75678245303c6e51.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 5,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
<link rel="stylesheet" href="../reference/_styles-quartodoc.css">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../static/logo-removebg.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">prophetverse</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-tutorials-üìö" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Tutorials üìö</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-tutorials-üìö">    
        <li>
    <a class="dropdown-item" href="../tutorials/univariate.html">
 <span class="dropdown-text">Univariate forecasting</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorials/tuning.html">
 <span class="dropdown-text">Hyperparameter tuning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorials/hierarchical.html">
 <span class="dropdown-text">Hierarchical Bayesian Model</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorials/count_data.html">
 <span class="dropdown-text">Count data forecasting</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-how-to-üõ†Ô∏è" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">How To üõ†Ô∏è</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-how-to-üõ†Ô∏è">    
        <li>
    <a class="dropdown-item" href="../howto/effect_api_intro.html">
 <span class="dropdown-text">Introduction to Effects</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../howto/custom_trend.html">
 <span class="dropdown-text">Custom trend</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../howto/custom_effects.html">
 <span class="dropdown-text">Custom exogenous effect</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../howto/composite_effects.html">
 <span class="dropdown-text">Creating composite effects</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../mmm"> 
<span class="menu-text">Marketing Mix Modeling üöÄ</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../the-theory.html"> 
<span class="menu-text">Mathematical Formulation üìñ</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../reference"> 
<span class="menu-text">API Reference</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">‚ú®</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-">    
        <li>
    <a class="dropdown-item" href="../prompts/custom_effects.html">
 <span class="dropdown-text">Custom Effect Prompt</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-github" role="link" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-bi-github">    
        <li>
    <a class="dropdown-item" href="https://github.com/felipeangelimvieira/prophetverse">
 <span class="dropdown-text">Source Code</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../development.html">
 <span class="dropdown-text">Development guide</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-discord" role="link" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-discord" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-bi-discord">    
        <li>
    <a class="dropdown-item" href="https://discord.com/channels/1075852648688930887/1372332867111358504">
 <span class="dropdown-text">Join the community</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-version" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Version</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-version">    
        <li>
    <a class="dropdown-item" href="../latest">
 <span class="dropdown-text">latest</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://prophetverse.com/0.6.0">
 <span class="dropdown-text">0.6.0</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../mmm/budget_allocation.html">Budget Optimization</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../mmm/fitting_and_calibration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fitting, calibrating and Unified Marketing Measurement</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../mmm/budget_allocation.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Budget Optimization</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#part-1-optimizing-for-a-single-time-series" id="toc-part-1-optimizing-for-a-single-time-series" class="nav-link active" data-scroll-target="#part-1-optimizing-for-a-single-time-series">Part 1: Optimizing for a Single Time Series</a>
  <ul class="collapse">
  <li><a href="#setting-up-the-problem" id="toc-setting-up-the-problem" class="nav-link" data-scroll-target="#setting-up-the-problem">1.1. Setting Up the Problem</a>
  <ul class="collapse">
  <li><a href="#load-synthetic-data" id="toc-load-synthetic-data" class="nav-link" data-scroll-target="#load-synthetic-data">1.1.1. Load synthetic data</a></li>
  <li><a href="#utility-plotting-functions" id="toc-utility-plotting-functions" class="nav-link" data-scroll-target="#utility-plotting-functions">1.1.2. Utility plotting functions</a></li>
  </ul></li>
  <li><a href="#budget-optimization" id="toc-budget-optimization" class="nav-link" data-scroll-target="#budget-optimization">1.2. Budget Optimization</a>
  <ul class="collapse">
  <li><a href="#maximizing-a-kpi" id="toc-maximizing-a-kpi" class="nav-link" data-scroll-target="#maximizing-a-kpi">1.2.1. Maximizing a KPI</a></li>
  <li><a href="#reparametrization-optimizing-channel-share" id="toc-reparametrization-optimizing-channel-share" class="nav-link" data-scroll-target="#reparametrization-optimizing-channel-share">1.2.2. Reparametrization: Optimizing channel share</a></li>
  <li><a href="#minimizing-budget-to-reach-a-target" id="toc-minimizing-budget-to-reach-a-target" class="nav-link" data-scroll-target="#minimizing-budget-to-reach-a-target">1.2.3. Minimizing budget to reach a target</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#part-2-optimizing-for-multiple-time-series-panel-data" id="toc-part-2-optimizing-for-multiple-time-series-panel-data" class="nav-link" data-scroll-target="#part-2-optimizing-for-multiple-time-series-panel-data">Part 2: Optimizing for Multiple Time Series (Panel Data)</a>
  <ul class="collapse">
  <li><a href="#setting-up-the-problem-for-panel-data" id="toc-setting-up-the-problem-for-panel-data" class="nav-link" data-scroll-target="#setting-up-the-problem-for-panel-data">2.1. Setting Up the Problem for Panel Data</a>
  <ul class="collapse">
  <li><a href="#load-synthetic-panel-data" id="toc-load-synthetic-panel-data" class="nav-link" data-scroll-target="#load-synthetic-panel-data">2.1.1. Load synthetic panel data</a></li>
  <li><a href="#utility-plotting-functions-for-panel-data" id="toc-utility-plotting-functions-for-panel-data" class="nav-link" data-scroll-target="#utility-plotting-functions-for-panel-data">2.1.2. Utility plotting functions for panel data</a></li>
  </ul></li>
  <li><a href="#budget-optimization-for-panel-data" id="toc-budget-optimization-for-panel-data" class="nav-link" data-scroll-target="#budget-optimization-for-panel-data">2.2. Budget Optimization for Panel Data</a>
  <ul class="collapse">
  <li><a href="#maximizing-a-kpi-1" id="toc-maximizing-a-kpi-1" class="nav-link" data-scroll-target="#maximizing-a-kpi-1">2.2.1. Maximizing a KPI</a></li>
  <li><a href="#reparametrization-for-panel-data" id="toc-reparametrization-for-panel-data" class="nav-link" data-scroll-target="#reparametrization-for-panel-data">2.2.2. Reparametrization for Panel Data</a></li>
  <li><a href="#minimizing-budget-to-reach-a-target-with-panel-data" id="toc-minimizing-budget-to-reach-a-target-with-panel-data" class="nav-link" data-scroll-target="#minimizing-budget-to-reach-a-target-with-panel-data">2.2.3. Minimizing budget to reach a target with Panel Data</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Budget Optimization for Single and Multiple Time Series</h1>
</div>

<div>
  <div class="description">
    <em>Use Prophetverse to optimize media budget allocation across channels for one or many time series.</em>
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In this tutorial, you‚Äôll learn how to use Prophetverse‚Äôs budget-optimization module to:</p>
<ul>
<li><strong>Allocate daily spend across channels</strong> to maximize a key performance indicator (KPI).</li>
<li><strong>Minimize total spend</strong> required to achieve a target KPI.</li>
<li><strong>Handle both single and multiple time series</strong> (e.g., different geographies) seamlessly.</li>
</ul>
<p>You‚Äôll also see how to switch between different parametrizations without hassle, such as:</p>
<ul>
<li><strong>Daily-spend mode</strong>: Optimize the exact dollar amount for each day and channel.</li>
<li><strong>Share-of-budget mode</strong>: Fix your overall spending pattern and optimize only the channel shares.</li>
</ul>
<p>By the end, you‚Äôll know how to pick the right setup for your campaign goals and make adjustments in seconds.</p>
<section id="part-1-optimizing-for-a-single-time-series" class="level1">
<h1>Part 1: Optimizing for a Single Time Series</h1>
<section id="setting-up-the-problem" class="level2">
<h2 class="anchored" data-anchor-id="setting-up-the-problem">1.1. Setting Up the Problem</h2>
<p>First, let‚Äôs set up our environment and load the data for a single time series optimization.</p>
<div id="1cc335c8" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpyro</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>numpyro.enable_x64()</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.dates <span class="im">as</span> mdates</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">"seaborn-v0_8-whitegrid"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="load-synthetic-data" class="level3">
<h3 class="anchored" data-anchor-id="load-synthetic-data">1.1.1. Load synthetic data</h3>
<p>We will load a synthetic dataset and a pre-fitted Prophetverse model.</p>
<div id="9affe57d" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prophetverse.datasets._mmm.dataset1 <span class="im">import</span> get_dataset</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>y, X, lift_tests, true_components, model <span class="op">=</span> get_dataset()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="utility-plotting-functions" class="level3">
<h3 class="anchored" data-anchor-id="utility-plotting-functions">1.1.2. Utility plotting functions</h3>
<p>This helper function will allow us to compare spend before and after optimization.</p>
<div id="2204c0fb" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_spend_comparison(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    X_baseline,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    X_optimized,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    channels,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    indexer,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    baseline_title<span class="op">=</span><span class="st">"Baseline Spend: Pre-Optimization"</span>,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    optimized_title<span class="op">=</span><span class="st">"Optimized Spend: Maximizing KPI"</span>,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>),</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>figsize)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    X_baseline.loc[indexer, channels].plot(ax<span class="op">=</span>ax[<span class="dv">0</span>], linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    X_optimized.loc[indexer, channels].plot(ax<span class="op">=</span>ax[<span class="dv">1</span>], linewidth<span class="op">=</span><span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    ax[<span class="dv">0</span>].set_title(baseline_title, fontsize<span class="op">=</span><span class="dv">14</span>, weight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    ax[<span class="dv">1</span>].set_title(optimized_title, fontsize<span class="op">=</span><span class="dv">14</span>, weight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> a <span class="kw">in</span> ax:</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        a.set_ylabel(<span class="st">"Spend"</span>)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        a.set_xlabel(<span class="st">"Date"</span>)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>        a.legend(loc<span class="op">=</span><span class="st">"upper right"</span>, frameon<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>        a.grid(axis<span class="op">=</span><span class="st">"x"</span>, visible<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>        a.grid(axis<span class="op">=</span><span class="st">"y"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>        a.xaxis.set_major_formatter(mdates.DateFormatter(<span class="st">"%b"</span>))</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Align y-axis</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    y_max <span class="op">=</span> <span class="bu">max</span>(</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>        X_baseline.loc[indexer, channels].<span class="bu">max</span>().<span class="bu">max</span>(),</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>        X_optimized.loc[indexer, channels].<span class="bu">max</span>().<span class="bu">max</span>(),</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> a <span class="kw">in</span> ax:</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>        a.set_ylim(<span class="dv">0</span>, y_max <span class="op">*</span> <span class="fl">1.05</span>)</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig, ax</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="budget-optimization" class="level2">
<h2 class="anchored" data-anchor-id="budget-optimization">1.2. Budget Optimization</h2>
<p>The budget-optimization module is composed of three main components:</p>
<ul>
<li><strong>The objective function</strong>: What you want to optimize (e.g., maximize KPI).</li>
<li><strong>The constraints</strong>: Rules the optimization must follow (e.g., total budget).</li>
<li><strong>The parametrization transform</strong>: How the problem is parametrized (e.g., daily spend vs.&nbsp;channel shares).</li>
</ul>
<section id="maximizing-a-kpi" class="level3">
<h3 class="anchored" data-anchor-id="maximizing-a-kpi">1.2.1. Maximizing a KPI</h3>
<p>The <code>BudgetOptimizer</code> class is the main entry point. By default, it optimizes the daily spend for each channel to maximize a given KPI.</p>
<div id="a7171a83" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prophetverse.budget_optimization <span class="im">import</span> (</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    BudgetOptimizer,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    TotalBudgetConstraint,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    MaximizeKPI,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>budget_optimizer <span class="op">=</span> BudgetOptimizer(</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    objective<span class="op">=</span>MaximizeKPI(),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    constraints<span class="op">=</span>[TotalBudgetConstraint()],</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    options<span class="op">=</span>{<span class="st">"disp"</span>: <span class="va">True</span>, <span class="st">"maxiter"</span>:<span class="dv">1000</span>},</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let‚Äôs define our optimization horizon:</p>
<div id="bcd75e88" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>horizon <span class="op">=</span> pd.period_range(<span class="st">"2004-12-01"</span>, <span class="st">"2004-12-31"</span>, freq<span class="op">=</span><span class="st">"D"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we run the optimization:</p>
<div id="f818ee7f" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>start_time <span class="op">=</span> time.time()</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>X_opt <span class="op">=</span> budget_optimizer.optimize(</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>model,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    X<span class="op">=</span>X,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    horizon<span class="op">=</span>horizon,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"ad_spend_search"</span>, <span class="st">"ad_spend_social_media"</span>],</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>optimization_time <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Optimization completed in </span><span class="sc">{</span>optimization_time<span class="sc">:.2f}</span><span class="ss"> seconds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimization terminated successfully    (Exit mode 0)
            Current function value: -759895930.0122986
            Iterations: 99
            Function evaluations: 115
            Gradient evaluations: 95
Optimization completed in 2.35 seconds</code></pre>
</div>
</div>
<section id="baseline-vs.-optimized-spend" class="level4">
<h4 class="anchored" data-anchor-id="baseline-vs.-optimized-spend">Baseline vs.&nbsp;optimized spend</h4>
<p>Let‚Äôs compare the model‚Äôs predictions before and after the optimization.</p>
<div id="0007442f" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>y_pred_baseline <span class="op">=</span> model.predict(X<span class="op">=</span>X, fh<span class="op">=</span>horizon)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>y_pred_opt <span class="op">=</span> model.predict(X<span class="op">=</span>X_opt, fh<span class="op">=</span>horizon)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plot_spend_comparison(</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    X,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    X_opt,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"ad_spend_search"</span>, <span class="st">"ad_spend_social_media"</span>],</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    horizon,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>kpi_gain <span class="op">=</span> y_pred_opt.<span class="bu">sum</span>() <span class="op">/</span> y_pred_baseline.<span class="bu">sum</span>() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="ss">f"KPI gain: +</span><span class="sc">{</span>kpi_gain<span class="sc">:.2%}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="dv">16</span>,weight<span class="op">=</span><span class="st">"bold"</span>, y<span class="op">=</span><span class="fl">1.02</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="budget_allocation_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="reparametrization-optimizing-channel-share" class="level3">
<h3 class="anchored" data-anchor-id="reparametrization-optimizing-channel-share">1.2.2. Reparametrization: Optimizing channel share</h3>
<p>Instead of daily spend, we can optimize the <em>share</em> of the budget for each channel. This is useful for keeping a fixed spending pattern (e.g., for seasonal campaigns).</p>
<div id="4a795aed" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prophetverse.budget_optimization <span class="im">import</span> InvestmentPerChannelTransform</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>budget_optimizer_reparam <span class="op">=</span> BudgetOptimizer(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    objective<span class="op">=</span>MaximizeKPI(),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    constraints<span class="op">=</span>[TotalBudgetConstraint()],</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    parametrization_transform<span class="op">=</span>InvestmentPerChannelTransform(),</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    options<span class="op">=</span>{<span class="st">"disp"</span>: <span class="va">True</span>},</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>X_opt_reparam <span class="op">=</span> budget_optimizer_reparam.optimize(</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>model,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    X<span class="op">=</span>X,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    horizon<span class="op">=</span>horizon,</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"ad_spend_search"</span>, <span class="st">"ad_spend_social_media"</span>],</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimization terminated successfully    (Exit mode 0)
            Current function value: -738733788.63574
            Iterations: 11
            Function evaluations: 20
            Gradient evaluations: 10</code></pre>
</div>
</div>
<section id="baseline-vs.-optimized-spend-1" class="level4">
<h4 class="anchored" data-anchor-id="baseline-vs.-optimized-spend-1">Baseline vs.&nbsp;optimized spend</h4>
<div id="99320567" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>y_pred_opt_reparam <span class="op">=</span> model.predict(X<span class="op">=</span>X_opt_reparam, fh<span class="op">=</span>horizon)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plot_spend_comparison(</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    X,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    X_opt_reparam,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"ad_spend_search"</span>, <span class="st">"ad_spend_social_media"</span>],</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    horizon,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>kpi_gain <span class="op">=</span> y_pred_opt_reparam.<span class="bu">sum</span>() <span class="op">/</span> y_pred_baseline.<span class="bu">sum</span>() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="ss">f"KPI gain: +</span><span class="sc">{</span>kpi_gain<span class="sc">:.2%}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="dv">16</span>, weight<span class="op">=</span><span class="st">"bold"</span>, y<span class="op">=</span><span class="fl">1.02</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="budget_allocation_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="minimizing-budget-to-reach-a-target" class="level3">
<h3 class="anchored" data-anchor-id="minimizing-budget-to-reach-a-target">1.2.3. Minimizing budget to reach a target</h3>
<p>We can also change the objective to find the minimum investment required to achieve a specific KPI target. Let‚Äôs say we want a 30% increase in KPI compared to 2003.</p>
<div id="10e1a321" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prophetverse.budget_optimization <span class="im">import</span> (</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    MinimizeBudget,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    MinimumTargetResponse,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>target <span class="op">=</span> y.loc[<span class="st">"2003-12"</span>].<span class="bu">sum</span>() <span class="op">*</span> <span class="fl">1.30</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>budget_optimizer_min <span class="op">=</span> BudgetOptimizer(</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    objective<span class="op">=</span>MinimizeBudget(),</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    constraints<span class="op">=</span>[MinimumTargetResponse(target_response<span class="op">=</span>target, constraint_type<span class="op">=</span><span class="st">"eq"</span>)],</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    options<span class="op">=</span>{<span class="st">"disp"</span>: <span class="va">True</span>, <span class="st">"maxiter"</span> : <span class="dv">300</span>},</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>X0 <span class="op">=</span> X.copy()</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>X_opt_min <span class="op">=</span> budget_optimizer_min.optimize(</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>model,</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    X<span class="op">=</span>X0,</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    horizon<span class="op">=</span>horizon,</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"ad_spend_search"</span>, <span class="st">"ad_spend_social_media"</span>],</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimization terminated successfully    (Exit mode 0)
            Current function value: 3796555.321062596
            Iterations: 201
            Function evaluations: 204
            Gradient evaluations: 201</code></pre>
</div>
</div>
<section id="budget-and-prediction-comparison" class="level4">
<h4 class="anchored" data-anchor-id="budget-and-prediction-comparison">Budget and prediction comparison</h4>
<div id="8d7b190e" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>plot_spend_comparison(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    X0,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    X_opt_min,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"ad_spend_search"</span>, <span class="st">"ad_spend_social_media"</span>],</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    indexer<span class="op">=</span>horizon,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>y_pred_baseline_min <span class="op">=</span> model.predict(X<span class="op">=</span>X0, fh<span class="op">=</span>horizon)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>y_pred_opt_min <span class="op">=</span> model.predict(X<span class="op">=</span>X_opt_min, fh<span class="op">=</span>horizon)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"MMM Predictions </span><span class="ch">\n</span><span class="ss">"</span>,</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Baseline KPI: </span><span class="sc">{</span>y_pred_baseline_min<span class="sc">.</span><span class="bu">sum</span>()<span class="op">/</span><span class="fl">1e9</span><span class="sc">:.2f}</span><span class="ss"> B </span><span class="ch">\n</span><span class="ss">"</span>,</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Optimized KPI: </span><span class="sc">{</span>y_pred_opt_min<span class="sc">.</span><span class="bu">sum</span>()<span class="op">/</span><span class="fl">1e9</span><span class="sc">:.2f}</span><span class="ss"> B </span><span class="ch">\n</span><span class="ss">"</span>,</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Target KPI: </span><span class="sc">{</span>target<span class="op">/</span><span class="fl">1e9</span><span class="sc">:.2f}</span><span class="ss"> B </span><span class="ch">\n</span><span class="ss">"</span>,</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Baseline spend: "</span>,</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    X0.loc[horizon, [<span class="st">"ad_spend_search"</span>, <span class="st">"ad_spend_social_media"</span>]].<span class="bu">sum</span>().<span class="bu">sum</span>(),</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>,</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Optimized spend: "</span>,</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    X_opt_min.loc[horizon, [<span class="st">"ad_spend_search"</span>, <span class="st">"ad_spend_social_media"</span>]].<span class="bu">sum</span>().<span class="bu">sum</span>(),</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>,</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="budget_allocation_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>MMM Predictions 
 Baseline KPI: 0.73 B 
 Optimized KPI: 0.97 B 
 Target KPI: 0.97 B 
 Baseline spend:  1250679.3427392421 
 Optimized spend:  3796555.3210625956 
</code></pre>
</div>
</div>
</section>
</section>
</section>
</section>
<section id="part-2-optimizing-for-multiple-time-series-panel-data" class="level1">
<h1>Part 2: Optimizing for Multiple Time Series (Panel Data)</h1>
<p>The same <code>BudgetOptimizer</code> can be used for multiple time series (e.g., different geographies) without any changes to the API.</p>
<section id="setting-up-the-problem-for-panel-data" class="level2">
<h2 class="anchored" data-anchor-id="setting-up-the-problem-for-panel-data">2.1. Setting Up the Problem for Panel Data</h2>
<p>The main difference is that for panel data, we use a multi-index DataFrame, following <code>sktime</code> conventions.</p>
<section id="load-synthetic-panel-data" class="level3">
<h3 class="anchored" data-anchor-id="load-synthetic-panel-data">2.1.1. Load synthetic panel data</h3>
<div id="1cecf473" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prophetverse.datasets._mmm.dataset1_panel <span class="im">import</span> get_dataset</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>y_panel, X_panel, lift_tests_panel, true_components_panel, fitted_model_panel <span class="op">=</span> get_dataset()</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>y_panel</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">group</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">a</td>
<td data-quarto-table-cell-role="th">2000-01-01</td>
<td>1.120218e+07</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2000-01-02</td>
<td>1.146048e+07</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-01-03</td>
<td>1.156324e+07</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2000-01-04</td>
<td>1.161396e+07</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-01-05</td>
<td>1.162758e+07</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
</tr>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">b</td>
<td data-quarto-table-cell-role="th">2004-12-28</td>
<td>2.473478e+07</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2004-12-29</td>
<td>2.718986e+07</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2004-12-30</td>
<td>2.554932e+07</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2004-12-31</td>
<td>2.343510e+07</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2005-01-01</td>
<td>2.078426e+07</td>
</tr>
</tbody>
</table>

<p>3656 rows √ó 1 columns</p>
</div>
</div>
</div>
</section>
<section id="utility-plotting-functions-for-panel-data" class="level3">
<h3 class="anchored" data-anchor-id="utility-plotting-functions-for-panel-data">2.1.2. Utility plotting functions for panel data</h3>
<p>We‚Äôll define a new plotting function to handle the multi-indexed data.</p>
<div id="005d2772" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_spend_comparison_panel(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    X_baseline,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    X_optimized,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    channels,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    indexer,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    baseline_title<span class="op">=</span><span class="st">"Baseline Spend: Pre-Optimization"</span>,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    optimized_title<span class="op">=</span><span class="st">"Optimized Spend: Maximizing KPI"</span>,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>),</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    series_idx <span class="op">=</span> X_baseline.index.droplevel(<span class="op">-</span><span class="dv">1</span>).unique().tolist()</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    fig, axs <span class="op">=</span> plt.subplots(<span class="bu">len</span>(series_idx), <span class="dv">2</span>, figsize<span class="op">=</span>figsize, squeeze<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, series <span class="kw">in</span> <span class="bu">enumerate</span>(series_idx):</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        _X_baseline <span class="op">=</span> X_baseline.loc[series]</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>        _X_optimized <span class="op">=</span> X_optimized.loc[series]</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>        ax_row <span class="op">=</span> axs[i]</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>        _X_baseline.loc[indexer, channels].plot(ax<span class="op">=</span>ax_row[<span class="dv">0</span>], linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>        _X_optimized.loc[indexer, channels].plot(</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax_row[<span class="dv">1</span>], linewidth<span class="op">=</span><span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">"--"</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>        ax_row[<span class="dv">0</span>].set_title(<span class="ss">f"</span><span class="sc">{</span>series<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>baseline_title<span class="sc">}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="dv">14</span>, weight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>        ax_row[<span class="dv">1</span>].set_title(<span class="ss">f"</span><span class="sc">{</span>series<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>optimized_title<span class="sc">}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="dv">14</span>, weight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> a <span class="kw">in</span> ax_row:</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>            a.set_ylabel(<span class="st">"Spend"</span>)</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>            a.set_xlabel(<span class="st">"Date"</span>)</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>            a.legend(loc<span class="op">=</span><span class="st">"upper right"</span>, frameon<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>            a.grid(axis<span class="op">=</span><span class="st">"x"</span>, visible<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>            a.grid(axis<span class="op">=</span><span class="st">"y"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>            a.xaxis.set_major_formatter(mdates.DateFormatter(<span class="st">"%b"</span>))</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>        y_max <span class="op">=</span> <span class="bu">max</span>(</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>            _X_baseline.loc[indexer, channels].<span class="bu">max</span>().<span class="bu">max</span>(),</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>            _X_optimized.loc[indexer, channels].<span class="bu">max</span>().<span class="bu">max</span>(),</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> a <span class="kw">in</span> ax_row:</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>            a.set_ylim(<span class="dv">0</span>, y_max <span class="op">*</span> <span class="fl">1.05</span>)</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig, axs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="budget-optimization-for-panel-data" class="level2">
<h2 class="anchored" data-anchor-id="budget-optimization-for-panel-data">2.2. Budget Optimization for Panel Data</h2>
<section id="maximizing-a-kpi-1" class="level3">
<h3 class="anchored" data-anchor-id="maximizing-a-kpi-1">2.2.1. Maximizing a KPI</h3>
<p>By default, <code>BudgetOptimizer</code> will optimize the daily spend for each channel <em>for each series</em>.</p>
<div id="1377448b" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>budget_optimizer_panel <span class="op">=</span> BudgetOptimizer(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    objective<span class="op">=</span>MaximizeKPI(),</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    constraints<span class="op">=</span>[TotalBudgetConstraint()],</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    options<span class="op">=</span>{<span class="st">"disp"</span>: <span class="va">True</span>, <span class="st">"maxiter"</span>: <span class="dv">1000</span>},</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>X_opt_panel <span class="op">=</span> budget_optimizer_panel.optimize(</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>fitted_model_panel,</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    X<span class="op">=</span>X_panel,</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    horizon<span class="op">=</span>horizon,</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"ad_spend_search"</span>, <span class="st">"ad_spend_social_media"</span>],</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimization terminated successfully    (Exit mode 0)
            Current function value: -1723014730.7603638
            Iterations: 193
            Function evaluations: 201
            Gradient evaluations: 193</code></pre>
</div>
</div>
<section id="baseline-vs.-optimized-spend-2" class="level4">
<h4 class="anchored" data-anchor-id="baseline-vs.-optimized-spend-2">Baseline vs.&nbsp;optimized spend</h4>
<div id="b5b5e6c9" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>y_pred_baseline_panel <span class="op">=</span> fitted_model_panel.predict(X<span class="op">=</span>X_panel, fh<span class="op">=</span>horizon)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>y_pred_opt_panel <span class="op">=</span> fitted_model_panel.predict(X<span class="op">=</span>X_opt_panel, fh<span class="op">=</span>horizon)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plot_spend_comparison_panel(</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    X_panel,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    X_opt_panel,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"ad_spend_search"</span>, <span class="st">"ad_spend_social_media"</span>],</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    horizon,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>kpi_gain <span class="op">=</span> y_pred_opt_panel.values.<span class="bu">sum</span>() <span class="op">/</span> y_pred_baseline_panel.values.<span class="bu">sum</span>() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="ss">f"Total KPI gain: +</span><span class="sc">{</span>kpi_gain<span class="sc">:.2%}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="dv">16</span>, weight<span class="op">=</span><span class="st">"bold"</span>, y<span class="op">=</span><span class="fl">1.03</span>)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="budget_allocation_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="reparametrization-for-panel-data" class="level3">
<h3 class="anchored" data-anchor-id="reparametrization-for-panel-data">2.2.2. Reparametrization for Panel Data</h3>
<p>With panel data, we have more reparametrization options.</p>
<section id="optimizing-channel-share-globally" class="level4">
<h4 class="anchored" data-anchor-id="optimizing-channel-share-globally">Optimizing channel share (globally)</h4>
<p>This optimizes the share of budget for each channel, keeping the total investment and spending pattern fixed. The channel shares are the same across all series.</p>
<div id="16ff27bd" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prophetverse.budget_optimization <span class="im">import</span> InvestmentPerChannelTransform</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>budget_optimizer_panel_ch <span class="op">=</span> BudgetOptimizer(</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    objective<span class="op">=</span>MaximizeKPI(),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    constraints<span class="op">=</span>[TotalBudgetConstraint()],</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    parametrization_transform<span class="op">=</span>InvestmentPerChannelTransform(),</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    options<span class="op">=</span>{<span class="st">"disp"</span>: <span class="va">True</span>},</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>X_opt_panel_ch <span class="op">=</span> budget_optimizer_panel_ch.optimize(</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>fitted_model_panel,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    X<span class="op">=</span>X_panel,</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    horizon<span class="op">=</span>horizon,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"ad_spend_search"</span>, <span class="st">"ad_spend_social_media"</span>],</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="co"># You can plot the results using plot_spend_comparison_panel</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimization terminated successfully    (Exit mode 0)
            Current function value: -1674672737.6774194
            Iterations: 13
            Function evaluations: 13
            Gradient evaluations: 13</code></pre>
</div>
</div>
</section>
<section id="optimizing-investment-per-series" class="level4">
<h4 class="anchored" data-anchor-id="optimizing-investment-per-series">Optimizing investment per series</h4>
<p>This keeps the channel shares fixed within each series but optimizes the allocation of the total budget across the different series.</p>
<div id="4e62985e" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prophetverse.budget_optimization.parametrization_transformations <span class="im">import</span> InvestmentPerSeries</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>budget_optimizer_panel_s <span class="op">=</span> BudgetOptimizer(</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    objective<span class="op">=</span>MaximizeKPI(),</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    constraints<span class="op">=</span>[TotalBudgetConstraint()],</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    parametrization_transform<span class="op">=</span>InvestmentPerSeries(),</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    options<span class="op">=</span>{<span class="st">"disp"</span>: <span class="va">True</span>},</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>X_opt_panel_s <span class="op">=</span> budget_optimizer_panel_s.optimize(</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>fitted_model_panel,</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    X<span class="op">=</span>X_panel,</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    horizon<span class="op">=</span>horizon,</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"ad_spend_search"</span>, <span class="st">"ad_spend_social_media"</span>],</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="co"># You can plot the results using plot_spend_comparison_panel</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimization terminated successfully    (Exit mode 0)
            Current function value: -1680449341.6035411
            Iterations: 13
            Function evaluations: 13
            Gradient evaluations: 13</code></pre>
</div>
</div>
</section>
<section id="optimizing-share-per-channel-and-series" class="level4">
<h4 class="anchored" data-anchor-id="optimizing-share-per-channel-and-series">Optimizing share per channel and series</h4>
<p>This is the most granular reparametrization, optimizing the share of budget for each channel within each series.</p>
<div id="cfdc90e7" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prophetverse.budget_optimization.parametrization_transformations <span class="im">import</span> InvestmentPerChannelAndSeries</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>budget_optimizer_panel_cs <span class="op">=</span> BudgetOptimizer(</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    objective<span class="op">=</span>MaximizeKPI(),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    constraints<span class="op">=</span>[TotalBudgetConstraint()],</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    parametrization_transform<span class="op">=</span>InvestmentPerChannelAndSeries(),</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    options<span class="op">=</span>{<span class="st">"disp"</span>: <span class="va">True</span>},</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>X_opt_panel_cs <span class="op">=</span> budget_optimizer_panel_cs.optimize(</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>fitted_model_panel,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    X<span class="op">=</span>X_panel,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    horizon<span class="op">=</span>horizon,</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"ad_spend_search"</span>, <span class="st">"ad_spend_social_media"</span>],</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="co"># You can plot the results using plot_spend_comparison_panel</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimization terminated successfully    (Exit mode 0)
            Current function value: -1717879098.7472155
            Iterations: 29
            Function evaluations: 38
            Gradient evaluations: 28</code></pre>
</div>
</div>
</section>
</section>
<section id="minimizing-budget-to-reach-a-target-with-panel-data" class="level3">
<h3 class="anchored" data-anchor-id="minimizing-budget-to-reach-a-target-with-panel-data">2.2.3. Minimizing budget to reach a target with Panel Data</h3>
<p>Let‚Äôs find the minimum budget to achieve a 20% KPI increase across all series.</p>
<div id="b1263c49" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>target_panel <span class="op">=</span> y_panel.loc[pd.IndexSlice[:, horizon],].values.<span class="bu">sum</span>() <span class="op">*</span> <span class="fl">1.2</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>budget_optimizer_min_panel <span class="op">=</span> BudgetOptimizer(</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    objective<span class="op">=</span>MinimizeBudget(),</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    constraints<span class="op">=</span>[MinimumTargetResponse(target_response<span class="op">=</span>target_panel, constraint_type<span class="op">=</span><span class="st">"eq"</span>)],</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    options<span class="op">=</span>{<span class="st">"disp"</span>: <span class="va">True</span>, <span class="st">"maxiter"</span>: <span class="dv">300</span>},</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>X0_panel <span class="op">=</span> X_panel.copy()</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>X_opt_min_panel <span class="op">=</span> budget_optimizer_min_panel.optimize(</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>fitted_model_panel,</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    X<span class="op">=</span>X0_panel,</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    horizon<span class="op">=</span>horizon,</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"ad_spend_search"</span>, <span class="st">"ad_spend_social_media"</span>],</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimization terminated successfully    (Exit mode 0)
            Current function value: 7755666.6797344675
            Iterations: 285
            Function evaluations: 287
            Gradient evaluations: 285</code></pre>
</div>
</div>
<section id="budget-and-prediction-comparison-1" class="level4">
<h4 class="anchored" data-anchor-id="budget-and-prediction-comparison-1">Budget and prediction comparison</h4>
<div id="2d2b36d9" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>plot_spend_comparison_panel(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    X0_panel,</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    X_opt_min_panel,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"ad_spend_search"</span>, <span class="st">"ad_spend_social_media"</span>],</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    indexer<span class="op">=</span>horizon,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>y_pred_baseline_min_panel <span class="op">=</span> fitted_model_panel.predict(X<span class="op">=</span>X0_panel, fh<span class="op">=</span>horizon)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>y_pred_opt_min_panel <span class="op">=</span> fitted_model_panel.predict(X<span class="op">=</span>X_opt_min_panel, fh<span class="op">=</span>horizon)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"MMM Predictions </span><span class="ch">\n</span><span class="ss">"</span>,</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Baseline KPI: </span><span class="sc">{</span>y_pred_baseline_min_panel<span class="sc">.</span>values<span class="sc">.</span><span class="bu">sum</span>()<span class="op">/</span><span class="fl">1e9</span><span class="sc">:.2f}</span><span class="ss"> B </span><span class="ch">\n</span><span class="ss">"</span>,</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Optimized KPI: </span><span class="sc">{</span>y_pred_opt_min_panel<span class="sc">.</span>values<span class="sc">.</span><span class="bu">sum</span>()<span class="op">/</span><span class="fl">1e9</span><span class="sc">:.2f}</span><span class="ss"> B </span><span class="ch">\n</span><span class="ss">"</span>,</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Target KPI: </span><span class="sc">{</span>target_panel<span class="op">/</span><span class="fl">1e9</span><span class="sc">:.2f}</span><span class="ss"> B </span><span class="ch">\n</span><span class="ss">"</span>,</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Baseline spend: "</span>,</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    X0_panel.loc[</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>        pd.IndexSlice[:, horizon], [<span class="st">"ad_spend_search"</span>, <span class="st">"ad_spend_social_media"</span>]</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">sum</span>()</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">sum</span>(),</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>,</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Optimized spend: "</span>,</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>    X_opt_min_panel.loc[</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>        pd.IndexSlice[:, horizon], [<span class="st">"ad_spend_search"</span>, <span class="st">"ad_spend_social_media"</span>]</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">sum</span>()</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">sum</span>(),</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>,</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="budget_allocation_files/figure-html/cell-22-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>MMM Predictions 
 Baseline KPI: 1.63 B 
 Optimized KPI: 1.96 B 
 Target KPI: 1.96 B 
 Baseline spend:  4179163.3068621266 
 Optimized spend:  7755666.679734468 
</code></pre>
</div>
</div>
</section>
</section>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>We have seen the capabilities of the budget-optimization module for both single and multiple time series. The three key components are the objective function, the constraints, and the parametrization transform. You can also create your own custom components to tailor the optimization to your specific needs.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "Óßã";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>