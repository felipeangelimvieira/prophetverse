<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="A tutorial on building a Marketing Mix Model (MMM) with Prophetverse, including forecasting, calibration, and unified marketing measurement.">

<title>Forecasting, Calibration, and Unified Marketing Measurement ‚Äì prophetverse</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../static/logo-removebg.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-f2b1ffb2c002503e75678245303c6e51.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 5,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
<link rel="stylesheet" href="../reference/_styles-quartodoc.css">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../static/logo-removebg.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">prophetverse</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-tutorials-üìö" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Tutorials üìö</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-tutorials-üìö">    
        <li>
    <a class="dropdown-item" href="../tutorials/univariate.html">
 <span class="dropdown-text">Univariate forecasting</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorials/tuning.html">
 <span class="dropdown-text">Hyperparameter tuning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorials/hierarchical.html">
 <span class="dropdown-text">Hierarchical Bayesian Model</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorials/count_data.html">
 <span class="dropdown-text">Count data forecasting</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-how-to-üõ†Ô∏è" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">How To üõ†Ô∏è</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-how-to-üõ†Ô∏è">    
        <li>
    <a class="dropdown-item" href="../howto/effect_api_intro.html">
 <span class="dropdown-text">Introduction to Effects</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../howto/custom_trend.html">
 <span class="dropdown-text">Custom trend</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../howto/custom_effects.html">
 <span class="dropdown-text">Custom exogenous effect</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../howto/composite_effects.html">
 <span class="dropdown-text">Creating composite effects</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../mmm"> 
<span class="menu-text">Marketing Mix Modeling üöÄ</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../the-theory.html"> 
<span class="menu-text">Mathematical Formulation üìñ</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../reference"> 
<span class="menu-text">API Reference</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">‚ú®</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-">    
        <li>
    <a class="dropdown-item" href="../prompts/custom_effects.html">
 <span class="dropdown-text">Custom Effect Prompt</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-github" role="link" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-bi-github">    
        <li>
    <a class="dropdown-item" href="https://github.com/felipeangelimvieira/prophetverse">
 <span class="dropdown-text">Source Code</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../development.html">
 <span class="dropdown-text">Development guide</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-discord" role="link" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-discord" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-bi-discord">    
        <li>
    <a class="dropdown-item" href="https://discord.com/channels/1075852648688930887/1372332867111358504">
 <span class="dropdown-text">Join the community</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-version" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Version</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-version">    
        <li>
    <a class="dropdown-item" href="../latest">
 <span class="dropdown-text">latest</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://prophetverse.com/0.6.0">
 <span class="dropdown-text">0.6.0</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../mmm/fitting_and_calibration.html">Fitting, calibrating and Unified Marketing Measurement</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../mmm/fitting_and_calibration.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Fitting, calibrating and Unified Marketing Measurement</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../mmm/budget_allocation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Budget Optimization</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#part-1-forecasting-with-adstock-saturation-effects" id="toc-part-1-forecasting-with-adstock-saturation-effects" class="nav-link active" data-scroll-target="#part-1-forecasting-with-adstock-saturation-effects">Part 1: Forecasting with Adstock &amp; Saturation Effects</a>
  <ul class="collapse">
  <li><a href="#component-level-diagnostics" id="toc-component-level-diagnostics" class="nav-link" data-scroll-target="#component-level-diagnostics">1.1 Component-Level Diagnostics</a></li>
  <li><a href="#backtesting-with-cross-validation" id="toc-backtesting-with-cross-validation" class="nav-link" data-scroll-target="#backtesting-with-cross-validation">1.2 Backtesting with Cross-Validation</a></li>
  <li><a href="#saturation-curves" id="toc-saturation-curves" class="nav-link" data-scroll-target="#saturation-curves">1.3 Saturation Curves</a></li>
  </ul></li>
  <li><a href="#part-2-calibration-with-causal-evidence" id="toc-part-2-calibration-with-causal-evidence" class="nav-link" data-scroll-target="#part-2-calibration-with-causal-evidence">Part 2: Calibration with Causal Evidence</a>
  <ul class="collapse">
  <li><a href="#visualizing-lift-tests" id="toc-visualizing-lift-tests" class="nav-link" data-scroll-target="#visualizing-lift-tests">2.1 Visualizing Lift Tests</a></li>
  <li><a href="#improve-estimates-via-liftexperimentlikelihood" id="toc-improve-estimates-via-liftexperimentlikelihood" class="nav-link" data-scroll-target="#improve-estimates-via-liftexperimentlikelihood">2.2 Improve Estimates via LiftExperimentLikelihood</a></li>
  <li><a href="#add-attribution-signals-with-exactlikelihood" id="toc-add-attribution-signals-with-exactlikelihood" class="nav-link" data-scroll-target="#add-attribution-signals-with-exactlikelihood">2.3 Add Attribution Signals with ExactLikelihood</a></li>
  </ul></li>
  <li><a href="#final-thoughts-toward-unified-marketing-measurement" id="toc-final-thoughts-toward-unified-marketing-measurement" class="nav-link" data-scroll-target="#final-thoughts-toward-unified-marketing-measurement">Final Thoughts: Toward Unified Marketing Measurement</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Forecasting, Calibration, and Unified Marketing Measurement</h1>
</div>

<div>
  <div class="description">
    <em>A tutorial on building a Marketing Mix Model (MMM) with Prophetverse, including forecasting, calibration, and unified marketing measurement</em>.
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<hr>
<p>In this tutorial, we walk through the lifecycle of a modern Marketing Mix Model (MMM), from time-series forecasting to incorporating causal evidence like lift tests and attribution.</p>
<p>You will learn:</p>
<ol type="1">
<li>How to <strong>forecast</strong> revenue using media spend with Adstock and Saturation effects.<br>
</li>
<li>How to <strong>diagnose model behavior</strong> and evaluate with backtesting.<br>
</li>
<li>Why <strong>correlated spend channels</strong> confuse effect estimation‚Äîand how to fix it.<br>
</li>
<li>How to <strong>calibrate</strong> your model using <strong>lift tests</strong> and <strong>attribution models</strong> for better ROI measurement.</li>
</ol>
<p>üëâ <strong>Why this matters</strong>: MMMs are foundational for budget allocation. But good predictions are not enough ‚Äî we need <strong>credible effect estimates</strong> to make real-world decisions.</p>
<p>Let‚Äôs get started!</p>
<p>Setting up some libraries, float64 precision, and plot style:</p>
<div id="210ae6a2" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpyro</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpyro.distributions <span class="im">as</span> dist</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">"seaborn-v0_8-whitegrid"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>numpyro.enable_x64()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="1008ae7b" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prophetverse.datasets._mmm.dataset1 <span class="im">import</span> get_dataset</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>y, X, lift_tests, true_components, _ <span class="op">=</span> get_dataset()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>lift_test_search, lift_test_social <span class="op">=</span> lift_tests</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"y shape: </span><span class="sc">{</span>y<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">, X shape: </span><span class="sc">{</span>X<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>X.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>y shape: (1828,), X shape: (1828, 2)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ad_spend_search</th>
<th data-quarto-table-cell-role="th">ad_spend_social_media</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-01-01</td>
<td>89076.191178</td>
<td>98587.488958</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2000-01-02</td>
<td>88891.993106</td>
<td>99066.321168</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-01-03</td>
<td>89784.955064</td>
<td>97334.106903</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2000-01-04</td>
<td>89931.220681</td>
<td>101747.300585</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-01-05</td>
<td>89184.319596</td>
<td>93825.221809</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
<section id="part-1-forecasting-with-adstock-saturation-effects" class="level2">
<h2 class="anchored" data-anchor-id="part-1-forecasting-with-adstock-saturation-effects">Part 1: Forecasting with Adstock &amp; Saturation Effects</h2>
<p>Here we‚Äôll build a <strong>time-series forecasting model</strong> that includes:</p>
<ul>
<li><strong>Trend</strong> and <strong>seasonality</strong><br>
</li>
<li><strong>Lagged media effects</strong> (Adstock)<br>
</li>
<li><strong>Diminishing returns</strong> (Saturation / Hill curves)</li>
</ul>
<p>üîé <strong>Why this matters</strong>:<br>
Raw spend is <strong>not immediately effective</strong>, and it <strong>doesn‚Äôt convert linearly</strong>.<br>
Capturing these dynamics is essential to make ROI estimates realistic.</p>
<div id="fac7af63" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prophetverse.effects <span class="im">import</span> (</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    PiecewiseLinearTrend,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    LinearFourierSeasonality,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    ChainedEffects,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    GeometricAdstockEffect,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    HillEffect,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prophetverse.sktime <span class="im">import</span> Prophetverse</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prophetverse.engine <span class="im">import</span> MAPInferenceEngine</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prophetverse.engine.optimizer <span class="im">import</span> LBFGSSolver</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>yearly <span class="op">=</span> (</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"yearly_seasonality"</span>,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    LinearFourierSeasonality(freq<span class="op">=</span><span class="st">"D"</span>, sp_list<span class="op">=</span>[<span class="fl">365.25</span>], fourier_terms_list<span class="op">=</span>[<span class="dv">5</span>], prior_scale<span class="op">=</span><span class="fl">0.1</span>, effect_mode<span class="op">=</span><span class="st">"multiplicative"</span>),</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="va">None</span>,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>weekly <span class="op">=</span> (</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"weekly_seasonality"</span>,</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    LinearFourierSeasonality(freq<span class="op">=</span><span class="st">"D"</span>, sp_list<span class="op">=</span>[<span class="dv">7</span>], fourier_terms_list<span class="op">=</span>[<span class="dv">3</span>], prior_scale<span class="op">=</span><span class="fl">0.05</span>, effect_mode<span class="op">=</span><span class="st">"multiplicative"</span>),</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="va">None</span>,</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>hill <span class="op">=</span> HillEffect(</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    half_max_prior<span class="op">=</span>dist.HalfNormal(<span class="dv">1</span>),</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    slope_prior<span class="op">=</span>dist.InverseGamma(<span class="dv">2</span>, <span class="dv">1</span>),</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    max_effect_prior<span class="op">=</span>dist.HalfNormal(<span class="dv">1</span>),</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    effect_mode<span class="op">=</span><span class="st">"additive"</span>,</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    input_scale<span class="op">=</span><span class="fl">1e6</span>,</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>chained_search <span class="op">=</span> (</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ad_spend_search"</span>,</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    ChainedEffects([(<span class="st">"adstock"</span>, GeometricAdstockEffect()), (<span class="st">"saturation"</span>, hill)]),</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ad_spend_search"</span>,</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>chained_social <span class="op">=</span> (</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ad_spend_social_media"</span>,</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    ChainedEffects([(<span class="st">"adstock"</span>, GeometricAdstockEffect()), (<span class="st">"saturation"</span>, hill)]),</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ad_spend_social_media"</span>,</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="2971b2b9" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>baseline_model <span class="op">=</span> Prophetverse(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    trend<span class="op">=</span>PiecewiseLinearTrend(changepoint_interval<span class="op">=</span><span class="dv">100</span>),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    exogenous_effects<span class="op">=</span>[yearly, weekly, chained_search, chained_social],</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    inference_engine<span class="op">=</span>MAPInferenceEngine(</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        num_steps<span class="op">=</span><span class="dv">5000</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        optimizer<span class="op">=</span>LBFGSSolver(memory_size<span class="op">=</span><span class="dv">300</span>, max_linesearch_steps<span class="op">=</span><span class="dv">300</span>),</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>baseline_model.fit(y<span class="op">=</span>y, X<span class="op">=</span>X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<style>#sk-539093d9-0b18-47cf-9bf1-bc93bbed67af {
    /* Definition of color scheme common for light and dark mode */
    --sklearn-color-text: black;
    --sklearn-color-line: gray;
    /* Definition of color scheme for objects */
    --sklearn-color-level-0: #fff5e6;
    --sklearn-color-level-1: #f6e4d2;
    --sklearn-color-level-2: #ffe0b3;
    --sklearn-color-level-3: chocolate;

    /* Specific color for light theme */
    --sklearn-color-text-on-default-background: var(--theme-code-foreground, var(--jp-content-font-color1, black));
    --sklearn-color-background: var(--theme-background, var(--jp-layout-color0, white));
    --sklearn-color-border-box: var(--theme-code-foreground, var(--jp-content-font-color1, black));
    --sklearn-color-icon: #696969;

    @media (prefers-color-scheme: dark) {
      /* Redefinition of color scheme for dark theme */
      --sklearn-color-text-on-default-background: var(--theme-code-foreground, var(--jp-content-font-color1, white));
      --sklearn-color-background: var(--theme-background, var(--jp-layout-color0, #111));
      --sklearn-color-border-box: var(--theme-code-foreground, var(--jp-content-font-color1, white));
      --sklearn-color-icon: #878787;
    }
  }

  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af {
    color: var(--sklearn-color-text);
  }

  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af pre {
    padding: 0;
  }

  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af input.sk-hidden--visually {
    border: 0;
    clip: rect(1px 1px 1px 1px);
    clip: rect(1px, 1px, 1px, 1px);
    height: 1px;
    margin: -1px;
    overflow: hidden;
    padding: 0;
    position: absolute;
    width: 1px;
  }

  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af div.sk-dashed-wrapped {
    border: 1px dashed var(--sklearn-color-line);
    margin: 0 0.4em 0.5em 0.4em;
    box-sizing: border-box;
    padding-bottom: 0.4em;
    background-color: var(--sklearn-color-background);
  }

  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af div.sk-container {
    /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
       but bootstrap.min.css set `[hidden] { display: none !important; }`
       so we also need the `!important` here to be able to override the
       default hidden behavior on the sphinx rendered scikit-learn.org.
       See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
    display: inline-block !important;
    position: relative;
  }

  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af div.sk-text-repr-fallback {
    display: none;
  }

  div.sk-parallel-item,
  div.sk-serial,
  div.sk-item {
    /* draw centered vertical line to link estimators */
    background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
    background-size: 2px 100%;
    background-repeat: no-repeat;
    background-position: center center;
  }

  /* Parallel-specific style estimator block */

  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af div.sk-parallel-item::after {
    content: "";
    width: 100%;
    border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
    flex-grow: 1;
  }

  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af div.sk-parallel {
    display: flex;
    align-items: stretch;
    justify-content: center;
    background-color: var(--sklearn-color-background);
    position: relative;
  }

  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af div.sk-parallel-item {
    display: flex;
    flex-direction: column;
  }

  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af div.sk-parallel-item:first-child::after {
    align-self: flex-end;
    width: 50%;
  }

  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af div.sk-parallel-item:last-child::after {
    align-self: flex-start;
    width: 50%;
  }

  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af div.sk-parallel-item:only-child::after {
    width: 0;
  }

  /* Serial-specific style estimator block */

  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af div.sk-serial {
    display: flex;
    flex-direction: column;
    align-items: center;
    background-color: var(--sklearn-color-background);
    padding-right: 1em;
    padding-left: 1em;
  }


  /* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
  clickable and can be expanded/collapsed.
  - Pipeline and ColumnTransformer use this feature and define the default style
  - Estimators will overwrite some part of the style using the `sk-estimator` class
  */

  /* Pipeline and ColumnTransformer style (default) */

  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af div.sk-toggleable {
    /* Default theme specific background. It is overwritten whether we have a
    specific estimator or a Pipeline/ColumnTransformer */
    background-color: var(--sklearn-color-background);
  }

  /* Toggleable label */
  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af label.sk-toggleable__label {
    cursor: pointer;
    display: block;
    width: 100%;
    margin-bottom: 0;
    padding: 0.5em;
    box-sizing: border-box;
    text-align: center;
  }

  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af label.sk-toggleable__label-arrow:before {
    /* Arrow on the left of the label */
    content: "‚ñ∏";
    float: left;
    margin-right: 0.25em;
    color: var(--sklearn-color-icon);
  }

  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af label.sk-toggleable__label-arrow:hover:before {
    color: var(--sklearn-color-text);
  }

  /* Toggleable content - dropdown */

  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af div.sk-toggleable__content {
    max-height: 0;
    max-width: 0;
    overflow: hidden;
    text-align: left;
    background-color: var(--sklearn-color-level-0);
  }

  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af div.sk-toggleable__content pre {
    margin: 0.2em;
    border-radius: 0.25em;
    color: var(--sklearn-color-text);
    background-color: var(--sklearn-color-level-0);
  }

  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af input.sk-toggleable__control:checked~div.sk-toggleable__content {
    /* Expand drop-down */
    max-height: 200px;
    max-width: 100%;
    overflow: auto;
  }

  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
    content: "‚ñæ";
  }

  /* Pipeline/ColumnTransformer-specific style */

  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
    color: var(--sklearn-color-text);
    background-color: var(--sklearn-color-level-2);
  }

  /* Estimator-specific style */

  /* Colorize estimator box */
  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
    /* unfitted */
    background-color: var(--sklearn-color-level-2);
  }

  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af div.sk-label label.sk-toggleable__label,
  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af div.sk-label label {
    /* The background is the default theme color */
    color: var(--sklearn-color-text-on-default-background);
  }

  /* On hover, darken the color of the background */
  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af div.sk-label:hover label.sk-toggleable__label {
    color: var(--sklearn-color-text);
    background-color: var(--sklearn-color-level-2);
  }

  /* Estimator label */

  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af div.sk-label label {
    font-family: monospace;
    font-weight: bold;
    display: inline-block;
    line-height: 1.2em;
  }

  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af div.sk-label-container {
    text-align: center;
  }

  /* Estimator-specific */
  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af div.sk-estimator {
    font-family: monospace;
    border: 1px dotted var(--sklearn-color-border-box);
    border-radius: 0.25em;
    box-sizing: border-box;
    margin-bottom: 0.5em;
    background-color: var(--sklearn-color-level-0);
  }

  /* on hover */
  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af div.sk-estimator:hover {
    background-color: var(--sklearn-color-level-2);
  }

  /* Specification for estimator info */

  .sk-estimator-doc-link,
  a:link.sk-estimator-doc-link,
  a:visited.sk-estimator-doc-link {
    float: right;
    font-size: smaller;
    line-height: 1em;
    font-family: monospace;
    background-color: var(--sklearn-color-background);
    border-radius: 1em;
    height: 1em;
    width: 1em;
    text-decoration: none !important;
    margin-left: 1ex;
    border: var(--sklearn-color-level-1) 1pt solid;
    color: var(--sklearn-color-level-1);
  }

  /* On hover */
  div.sk-estimator:hover .sk-estimator-doc-link:hover,
  .sk-estimator-doc-link:hover,
  div.sk-label-container:hover .sk-estimator-doc-link:hover,
  .sk-estimator-doc-link:hover {
    background-color: var(--sklearn-color-level-3);
    color: var(--sklearn-color-background);
    text-decoration: none;
  }

  /* Span, style for the box shown on hovering the info icon */
  .sk-estimator-doc-link span {
    display: none;
    z-index: 9999;
    position: relative;
    font-weight: normal;
    right: .2ex;
    padding: .5ex;
    margin: .5ex;
    width: min-content;
    min-width: 20ex;
    max-width: 50ex;
    color: var(--sklearn-color-text);
    box-shadow: 2pt 2pt 4pt #999;
    background: var(--sklearn-color-level-0);
    border: .5pt solid var(--sklearn-color-level-3);
  }

  .sk-estimator-doc-link:hover span {
    display: block;
  }

  /* "?"-specific style due to the `<a>` HTML tag */

  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af a.estimator_doc_link {
    float: right;
    font-size: 1rem;
    line-height: 1em;
    font-family: monospace;
    background-color: var(--sklearn-color-background);
    border-radius: 1rem;
    height: 1rem;
    width: 1rem;
    text-decoration: none;
    color: var(--sklearn-color-level-1);
    border: var(--sklearn-color-level-1) 1pt solid;
  }

  /* On hover */
  #sk-539093d9-0b18-47cf-9bf1-bc93bbed67af a.estimator_doc_link:hover {
    background-color: var(--sklearn-color-level-3);
    color: var(--sklearn-color-background);
    text-decoration: none;
  }
</style><div id="sk-539093d9-0b18-47cf-9bf1-bc93bbed67af" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>Prophetverse(exogenous_effects=[('yearly_seasonality',
                                 LinearFourierSeasonality(effect_mode='multiplicative',
                                                          fourier_terms_list=[5],
                                                          freq='D',
                                                          prior_scale=0.1,
                                                          sp_list=[365.25]),
                                 None),
                                ('weekly_seasonality',
                                 LinearFourierSeasonality(effect_mode='multiplicative',
                                                          fourier_terms_list=[3],
                                                          freq='D',
                                                          prior_scale=0.05,
                                                          sp_list=[7]),
                                 None),
                                ('ad_spend_search',
                                 Chained...
                                                                   max_effect_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b8150450 with batch shape () and event shape ()&gt;,
                                                                   slope_prior=&lt;numpyro.distributions.continuous.InverseGamma object at 0x7f9479f14310 with batch shape () and event shape ()&gt;))]),
                                 'ad_spend_social_media')],
             inference_engine=MAPInferenceEngine(num_steps=5000,
                                                 optimizer=LBFGSSolver(max_linesearch_steps=300,
                                                                       memory_size=300)),
             trend=PiecewiseLinearTrend(changepoint_interval=100))</pre><b>Please rerun this cell to show the HTML repr or trust the notebook.</b></div><div class="sk-container" hidden=""><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('6cbda279-a159-41b4-b1b6-3c2459aeca7b')" type="checkbox"><label for="UUID('6cbda279-a159-41b4-b1b6-3c2459aeca7b')" class="sk-toggleable__label sk-toggleable__label-arrow">Prophetverse</label><div class="sk-toggleable__content"><pre>Prophetverse(exogenous_effects=[('yearly_seasonality',
                                 LinearFourierSeasonality(effect_mode='multiplicative',
                                                          fourier_terms_list=[5],
                                                          freq='D',
                                                          prior_scale=0.1,
                                                          sp_list=[365.25]),
                                 None),
                                ('weekly_seasonality',
                                 LinearFourierSeasonality(effect_mode='multiplicative',
                                                          fourier_terms_list=[3],
                                                          freq='D',
                                                          prior_scale=0.05,
                                                          sp_list=[7]),
                                 None),
                                ('ad_spend_search',
                                 Chained...
                                                                   max_effect_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b8150450 with batch shape () and event shape ()&gt;,
                                                                   slope_prior=&lt;numpyro.distributions.continuous.InverseGamma object at 0x7f9479f14310 with batch shape () and event shape ()&gt;))]),
                                 'ad_spend_social_media')],
             inference_engine=MAPInferenceEngine(num_steps=5000,
                                                 optimizer=LBFGSSolver(max_linesearch_steps=300,
                                                                       memory_size=300)),
             trend=PiecewiseLinearTrend(changepoint_interval=100))</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><label>effects</label></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('0a0b96d5-1807-4456-9057-cbdab17d1a1a')" type="checkbox"><label for="UUID('0a0b96d5-1807-4456-9057-cbdab17d1a1a')" class="sk-toggleable__label sk-toggleable__label-arrow">PiecewiseLinearTrend</label><div class="sk-toggleable__content"><pre>PiecewiseLinearTrend(changepoint_interval=100)</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('1ad69197-55bf-4b06-b20c-fc02aadcc8a9')" type="checkbox"><label for="UUID('1ad69197-55bf-4b06-b20c-fc02aadcc8a9')" class="sk-toggleable__label sk-toggleable__label-arrow">LinearFourierSeasonality</label><div class="sk-toggleable__content"><pre>LinearFourierSeasonality(effect_mode='multiplicative', fourier_terms_list=[5],
                         freq='D', prior_scale=0.1, sp_list=[365.25])</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('29f7fd1c-8319-42a2-8172-83da4c89946b')" type="checkbox"><label for="UUID('29f7fd1c-8319-42a2-8172-83da4c89946b')" class="sk-toggleable__label sk-toggleable__label-arrow">LinearFourierSeasonality</label><div class="sk-toggleable__content"><pre>LinearFourierSeasonality(effect_mode='multiplicative', fourier_terms_list=[3],
                         freq='D', prior_scale=0.05, sp_list=[7])</pre></div></div></div><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('e8fc1310-fcf8-474c-b70b-31a951ae30fe')" type="checkbox"><label for="UUID('e8fc1310-fcf8-474c-b70b-31a951ae30fe')" class="sk-toggleable__label sk-toggleable__label-arrow">ad_spend_search</label><div class="sk-toggleable__content"><pre>ChainedEffects(steps=[('adstock', GeometricAdstockEffect()),
                      ('saturation',
                       HillEffect(effect_mode='additive',
                                  half_max_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b85cc890 with batch shape () and event shape ()&gt;,
                                  input_scale=1000000.0,
                                  max_effect_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b8150450 with batch shape () and event shape ()&gt;,
                                  slope_prior=&lt;numpyro.distributions.continuous.InverseGamma object at 0x7f9479f14310 with batch shape () and event shape ()&gt;))])</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('7fc826db-91a6-4792-b2ca-d64874c3150f')" type="checkbox"><label for="UUID('7fc826db-91a6-4792-b2ca-d64874c3150f')" class="sk-toggleable__label sk-toggleable__label-arrow">GeometricAdstockEffect</label><div class="sk-toggleable__content"><pre>GeometricAdstockEffect()</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('4dd87828-438b-4757-9712-bce16815e68e')" type="checkbox"><label for="UUID('4dd87828-438b-4757-9712-bce16815e68e')" class="sk-toggleable__label sk-toggleable__label-arrow">HillEffect</label><div class="sk-toggleable__content"><pre>HillEffect(effect_mode='additive',
           half_max_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b85cc890 with batch shape () and event shape ()&gt;,
           input_scale=1000000.0,
           max_effect_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b8150450 with batch shape () and event shape ()&gt;,
           slope_prior=&lt;numpyro.distributions.continuous.InverseGamma object at 0x7f9479f14310 with batch shape () and event shape ()&gt;)</pre></div></div></div></div></div><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('0f53ff1b-4848-4a16-8fdf-256cca933a8d')" type="checkbox"><label for="UUID('0f53ff1b-4848-4a16-8fdf-256cca933a8d')" class="sk-toggleable__label sk-toggleable__label-arrow">ad_spend_social_media</label><div class="sk-toggleable__content"><pre>ChainedEffects(steps=[('adstock', GeometricAdstockEffect()),
                      ('saturation',
                       HillEffect(effect_mode='additive',
                                  half_max_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b85cc890 with batch shape () and event shape ()&gt;,
                                  input_scale=1000000.0,
                                  max_effect_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b8150450 with batch shape () and event shape ()&gt;,
                                  slope_prior=&lt;numpyro.distributions.continuous.InverseGamma object at 0x7f9479f14310 with batch shape () and event shape ()&gt;))])</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('c3823d44-c6e6-402d-8094-928706830eb7')" type="checkbox"><label for="UUID('c3823d44-c6e6-402d-8094-928706830eb7')" class="sk-toggleable__label sk-toggleable__label-arrow">GeometricAdstockEffect</label><div class="sk-toggleable__content"><pre>GeometricAdstockEffect()</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('7cf6127f-409d-48b2-b4b0-5ae476efbfe9')" type="checkbox"><label for="UUID('7cf6127f-409d-48b2-b4b0-5ae476efbfe9')" class="sk-toggleable__label sk-toggleable__label-arrow">HillEffect</label><div class="sk-toggleable__content"><pre>HillEffect(effect_mode='additive',
           half_max_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b85cc890 with batch shape () and event shape ()&gt;,
           input_scale=1000000.0,
           max_effect_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b8150450 with batch shape () and event shape ()&gt;,
           slope_prior=&lt;numpyro.distributions.continuous.InverseGamma object at 0x7f9479f14310 with batch shape () and event shape ()&gt;)</pre></div></div></div></div></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><label>inference_engine</label></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('5531dadc-48b2-473a-94d3-4c248fb382bf')" type="checkbox"><label for="UUID('5531dadc-48b2-473a-94d3-4c248fb382bf')" class="sk-toggleable__label sk-toggleable__label-arrow">MAPInferenceEngine</label><div class="sk-toggleable__content"><pre>MAPInferenceEngine(num_steps=5000,
                   optimizer=LBFGSSolver(max_linesearch_steps=300,
                                         memory_size=300))</pre></div></div></div></div></div></div></div></div></div></div>
</div>
</div>
<div id="f02d10ad" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> baseline_model.predict(X<span class="op">=</span>X, fh<span class="op">=</span>X.index)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>y.plot(label<span class="op">=</span><span class="st">"Observed"</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>y_pred.plot(label<span class="op">=</span><span class="st">"Predicted"</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"In-Sample Forecast: Observed vs Predicted"</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fitting_and_calibration_files/figure-html/cell-7-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="component-level-diagnostics" class="level3">
<h3 class="anchored" data-anchor-id="component-level-diagnostics">1.1 Component-Level Diagnostics</h3>
<p>With <code>predict_components</code>, we can obtain the model‚Äôs components.</p>
<div id="94d94744" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>y_pred_components <span class="op">=</span> baseline_model.predict_components(X<span class="op">=</span>X, fh<span class="op">=</span>X.index)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>y_pred_components.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ad_spend_search</th>
<th data-quarto-table-cell-role="th">ad_spend_social_media</th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">obs</th>
<th data-quarto-table-cell-role="th">trend</th>
<th data-quarto-table-cell-role="th">weekly_seasonality</th>
<th data-quarto-table-cell-role="th">yearly_seasonality</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-01-01</td>
<td>1.088334e+06</td>
<td>9.004915e+06</td>
<td>1.004804e+07</td>
<td>1.002738e+07</td>
<td>-48745.535871</td>
<td>-2138.207290</td>
<td>5672.721642</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2000-01-02</td>
<td>1.190987e+06</td>
<td>9.809048e+06</td>
<td>1.096439e+07</td>
<td>1.092012e+07</td>
<td>-40184.364520</td>
<td>-63.639081</td>
<td>4598.553135</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-01-03</td>
<td>1.214480e+06</td>
<td>1.004536e+07</td>
<td>1.123137e+07</td>
<td>1.128964e+07</td>
<td>-31623.193169</td>
<td>-401.837574</td>
<td>3550.425506</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2000-01-04</td>
<td>1.219715e+06</td>
<td>1.017630e+07</td>
<td>1.137661e+07</td>
<td>1.133616e+07</td>
<td>-23062.021818</td>
<td>1114.022696</td>
<td>2534.209171</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-01-05</td>
<td>1.216466e+06</td>
<td>1.018372e+07</td>
<td>1.138733e+07</td>
<td>1.133869e+07</td>
<td>-14500.850467</td>
<td>88.816573</td>
<td>1555.673114</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>In a real use-casee, you would not have access to the ground truth of the components. We use them here to show how the model behaves, and how incorporing extra information can improve it.</p>
<div id="baa71540" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">4</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">12</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, name <span class="kw">in</span> <span class="bu">enumerate</span>(</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"trend"</span>, <span class="st">"yearly_seasonality"</span>, <span class="st">"ad_spend_search"</span>, <span class="st">"ad_spend_social_media"</span>]</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    true_components[name].plot(ax<span class="op">=</span>axs[i], label<span class="op">=</span><span class="st">"True"</span>, color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    y_pred_components[name].plot(ax<span class="op">=</span>axs[i], label<span class="op">=</span><span class="st">"Estimated"</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    axs[i].set_title(name)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    axs[i].legend()</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fitting_and_calibration_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="backtesting-with-cross-validation" class="level3">
<h3 class="anchored" data-anchor-id="backtesting-with-cross-validation">1.2 Backtesting with Cross-Validation</h3>
<p>We use rolling-window CV to assess out-of-sample accuracy using <strong>MAPE</strong>.</p>
<p>üß† <strong>Caution</strong>: Low error ‚â† correct attribution. But high error often indicates a bad model.</p>
<div id="6c8e6108" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.split <span class="im">import</span> ExpandingWindowSplitter</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.performance_metrics.forecasting <span class="im">import</span> MeanAbsolutePercentageError</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.forecasting.model_evaluation <span class="im">import</span> evaluate</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>metric <span class="op">=</span> MeanAbsolutePercentageError()</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> ExpandingWindowSplitter(</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    initial_window<span class="op">=</span><span class="dv">365</span> <span class="op">*</span> <span class="dv">3</span>, step_length<span class="op">=</span><span class="dv">180</span>, fh<span class="op">=</span><span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">180</span>))</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>cv_results <span class="op">=</span> evaluate(</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    forecaster<span class="op">=</span>baseline_model, y<span class="op">=</span>y, X<span class="op">=</span>X, cv<span class="op">=</span>cv, scoring<span class="op">=</span>metric, return_data<span class="op">=</span><span class="va">True</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>cv_results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">test_MeanAbsolutePercentageError</th>
<th data-quarto-table-cell-role="th">fit_time</th>
<th data-quarto-table-cell-role="th">pred_time</th>
<th data-quarto-table-cell-role="th">len_train_window</th>
<th data-quarto-table-cell-role="th">cutoff</th>
<th data-quarto-table-cell-role="th">y_train</th>
<th data-quarto-table-cell-role="th">y_test</th>
<th data-quarto-table-cell-role="th">y_pred</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.066920</td>
<td>33.569147</td>
<td>0.632124</td>
<td>1095</td>
<td>2002-12-30</td>
<td>2000-01-01 1.081551e+07 2000-01-02 1.112...</td>
<td>2002-12-31 1.306520e+07 2003-01-01 1.429...</td>
<td>2002-12-31 1.116013e+07 2003-01-01 1.167...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.061117</td>
<td>49.879113</td>
<td>0.576771</td>
<td>1275</td>
<td>2003-06-28</td>
<td>2000-01-01 1.081551e+07 2000-01-02 1.112...</td>
<td>2003-06-29 1.725815e+07 2003-06-30 1.696...</td>
<td>2003-06-29 1.619773e+07 2003-06-30 1.645...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.052211</td>
<td>20.683568</td>
<td>0.603466</td>
<td>1455</td>
<td>2003-12-25</td>
<td>2000-01-01 1.081551e+07 2000-01-02 1.112...</td>
<td>2003-12-26 2.511414e+07 2003-12-27 2.496...</td>
<td>2003-12-26 2.437842e+07 2003-12-27 2.476...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.057910</td>
<td>22.770432</td>
<td>0.595272</td>
<td>1635</td>
<td>2004-06-22</td>
<td>2000-01-01 1.081551e+07 2000-01-02 1.112...</td>
<td>2004-06-23 2.913561e+07 2004-06-24 2.878...</td>
<td>2004-06-23 3.056415e+07 2004-06-24 3.018...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The average error across folds is:</p>
<div id="86eb9114" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>cv_results[<span class="st">"test_MeanAbsolutePercentageError"</span>].mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>np.float64(0.059539628867870995)</code></pre>
</div>
</div>
<p>We can visualize them by iterating the dataframe:</p>
<div id="3dc3e696" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, row <span class="kw">in</span> cv_results.iterrows():</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">2</span>))</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    observed <span class="op">=</span> pd.concat([row[<span class="st">"y_train"</span>].iloc[<span class="op">-</span><span class="dv">100</span>:], row[<span class="st">"y_test"</span>]])</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    observed.plot(label<span class="op">=</span><span class="st">"Observed"</span>, color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    row[<span class="st">"y_pred"</span>].plot(label<span class="op">=</span><span class="st">"Prediction"</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f"Fold </span><span class="sc">{</span>idx <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss"> ‚Äì MAPE: </span><span class="sc">{</span>row[<span class="st">'test_MeanAbsolutePercentageError'</span>]<span class="sc">:.2%}</span><span class="ss">"</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> idx <span class="op">&gt;</span> <span class="dv">3</span>:</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fitting_and_calibration_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fitting_and_calibration_files/figure-html/cell-12-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fitting_and_calibration_files/figure-html/cell-12-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fitting_and_calibration_files/figure-html/cell-12-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="saturation-curves" class="level3">
<h3 class="anchored" data-anchor-id="saturation-curves">1.3 Saturation Curves</h3>
<p>These curves show <strong>diminishing marginal effect</strong> as spend increases.</p>
<p>üîç <strong>Insight</strong>: This shape helps guide budget allocation decisions (e.g.&nbsp;where additional spend will have little return).</p>
<p>Note how the model captures a saturation effect, but it is still far from the correct shape.</p>
<p>This is why, in many situations, you will need calibration to correct the model‚Äôs behavior. This is what we will do in the next section.</p>
<div id="3c09dac6" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>), nrows<span class="op">=</span><span class="dv">1</span>, ncols<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, channel <span class="kw">in</span> <span class="bu">zip</span>(axs, [<span class="st">"ad_spend_search"</span>, <span class="st">"ad_spend_social_media"</span>]):</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    ax.scatter(</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        X[channel],</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        y_pred_components[channel],</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.6</span>,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span>channel,</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    ax.scatter(</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        X[channel],</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        true_components[channel],</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"black"</span>,</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">"True Effect"</span>,</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    ax.<span class="bu">set</span>(</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>        xlabel<span class="op">=</span><span class="st">"Daily Spend"</span>,</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>        ylabel<span class="op">=</span><span class="st">"Incremental Effect"</span>,</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>channel<span class="sc">}</span><span class="ss"> - Saturation Curve"</span>,</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    ax.legend()</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fitting_and_calibration_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="part-2-calibration-with-causal-evidence" class="level2">
<h2 class="anchored" data-anchor-id="part-2-calibration-with-causal-evidence">Part 2: Calibration with Causal Evidence</h2>
<p>Time-series alone <strong>cannot disentangle</strong> correlated channels.</p>
<p>We integrate <strong>lift tests</strong> (local experiments) and <strong>attribution models</strong> (high-resolution signal) to correct this.</p>
<div id="bb39959c" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>lift_test_search</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">lift</th>
<th data-quarto-table-cell-role="th">x_start</th>
<th data-quarto-table-cell-role="th">x_end</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-09-04</td>
<td>0.986209</td>
<td>88991.849098</td>
<td>88616.674279</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2003-07-17</td>
<td>1.602655</td>
<td>25147.476284</td>
<td>30137.721832</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2004-04-11</td>
<td>0.762057</td>
<td>58323.761863</td>
<td>46723.500000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2003-01-06</td>
<td>0.758514</td>
<td>23857.995845</td>
<td>21913.505457</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2003-03-07</td>
<td>1.332419</td>
<td>29036.114641</td>
<td>31676.191662</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2001-01-17</td>
<td>1.142551</td>
<td>71184.337297</td>
<td>80915.848594</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2003-04-12</td>
<td>1.654931</td>
<td>36588.754410</td>
<td>46777.071912</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2002-02-16</td>
<td>0.825554</td>
<td>67892.914951</td>
<td>55030.729840</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2001-10-05</td>
<td>0.929293</td>
<td>69504.770296</td>
<td>65128.356512</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2000-10-02</td>
<td>0.994120</td>
<td>85176.526599</td>
<td>88936.541885</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2003-06-05</td>
<td>0.760863</td>
<td>27988.449143</td>
<td>24654.281482</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2000-07-07</td>
<td>0.897929</td>
<td>97458.154049</td>
<td>79856.919150</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2003-09-28</td>
<td>1.570214</td>
<td>42328.076114</td>
<td>54497.175586</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2002-08-24</td>
<td>0.863911</td>
<td>35824.789963</td>
<td>33256.068138</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-11-28</td>
<td>1.242113</td>
<td>69593.024187</td>
<td>92943.044427</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2001-12-28</td>
<td>0.881569</td>
<td>71500.973097</td>
<td>69504.085790</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2001-09-02</td>
<td>1.197270</td>
<td>69966.800254</td>
<td>93695.953636</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2002-12-16</td>
<td>1.660649</td>
<td>7810.413156</td>
<td>9322.237192</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2004-08-30</td>
<td>1.286178</td>
<td>47599.593625</td>
<td>56735.271957</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2001-02-18</td>
<td>1.254430</td>
<td>64837.275444</td>
<td>81784.074961</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-05-15</td>
<td>1.044025</td>
<td>100464.794301</td>
<td>121779.610581</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2004-08-13</td>
<td>0.967493</td>
<td>57864.200257</td>
<td>56080.324427</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2001-02-02</td>
<td>1.212479</td>
<td>67857.642170</td>
<td>88071.282712</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2001-05-21</td>
<td>1.178636</td>
<td>71337.927880</td>
<td>93445.016948</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2003-05-06</td>
<td>0.644814</td>
<td>25609.287364</td>
<td>21843.082411</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2000-07-31</td>
<td>1.012828</td>
<td>92617.293678</td>
<td>85766.681515</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2002-07-03</td>
<td>1.267595</td>
<td>57443.596207</td>
<td>66595.562035</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2004-09-27</td>
<td>1.369890</td>
<td>41546.443755</td>
<td>50176.823146</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-10-25</td>
<td>0.985062</td>
<td>72757.343228</td>
<td>70195.986606</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2002-11-02</td>
<td>0.834577</td>
<td>19043.272758</td>
<td>18373.397899</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<section id="visualizing-lift-tests" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-lift-tests">2.1 Visualizing Lift Tests</h3>
<p>Each experiment records: pre-spend (<code>x_start</code>), post-spend (<code>x_end</code>), and measured <code>lift</code>. These give us <strong>causal ‚Äúground truth‚Äù deltas</strong>.</p>
<div id="dc0b5594" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatter plot for pre-spend and observed lift</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>ax.scatter(lift_test_search[<span class="st">"x_start"</span>], [<span class="dv">1</span>] <span class="op">*</span> <span class="bu">len</span>(lift_test_search), label<span class="op">=</span><span class="st">"Pre-Spend"</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>ax.scatter(lift_test_search[<span class="st">"x_end"</span>], lift_test_search[<span class="st">"lift"</span>], label<span class="op">=</span><span class="st">"Observed Lift"</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Annotate with arrows to show lift effect</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> lift_test_search.iterrows():</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    ax.annotate(</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">""</span>,</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>        xy<span class="op">=</span>(row[<span class="st">"x_end"</span>], row[<span class="st">"lift"</span>]),</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>        xytext<span class="op">=</span>(row[<span class="st">"x_start"</span>], <span class="dv">1</span>),</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>        arrowprops<span class="op">=</span><span class="bu">dict</span>(arrowstyle<span class="op">=</span><span class="st">"-&gt;"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>),</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Add horizontal line and labels</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>ax.axhline(<span class="dv">1</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, color<span class="op">=</span><span class="st">"gray"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Search Ads Lift Tests"</span>,</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    xlabel<span class="op">=</span><span class="st">"Spend"</span>,</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">"Revenue Ratio"</span>,</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Add legend and finalize layout</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fitting_and_calibration_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="improve-estimates-via-liftexperimentlikelihood" class="level3">
<h3 class="anchored" data-anchor-id="improve-estimates-via-liftexperimentlikelihood">2.2 Improve Estimates via LiftExperimentLikelihood</h3>
<p>This adds a new <strong>likelihood term</strong> that makes the model match lift observations.</p>
<p>üîÅ <strong>Still Bayesian</strong>: It incorporates test variance and model uncertainty.</p>
<p>Since we use <code>sktime</code> interface, we have access to <code>get_params()</code> and <code>set_params(**kwargs)</code> methods. This allows us to <strong>easily swap</strong> effects and likelihoods. When we define our model, the effect‚Äôs name become a key in the model‚Äôs <code>get_params()</code> dictionary. We can use this to set the effect‚Äôs parameters directly.</p>
<div id="be1e386f" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prophetverse.effects.lift_likelihood <span class="im">import</span> LiftExperimentLikelihood</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>model_lift <span class="op">=</span> baseline_model.clone()</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>model_lift.set_params(</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    ad_spend_search<span class="op">=</span>LiftExperimentLikelihood(</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>        effect<span class="op">=</span>baseline_model.get_params()[<span class="st">"ad_spend_search"</span>],</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>        lift_test_results<span class="op">=</span>lift_test_search,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        prior_scale<span class="op">=</span><span class="fl">0.05</span>,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    ad_spend_social_media<span class="op">=</span>LiftExperimentLikelihood(</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>        effect<span class="op">=</span>baseline_model.get_params()[<span class="st">"ad_spend_social_media"</span>],</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>        lift_test_results<span class="op">=</span>lift_test_social,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>        prior_scale<span class="op">=</span><span class="fl">0.05</span>,</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>model_lift.fit(y<span class="op">=</span>y, X<span class="op">=</span>X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<style>#sk-997b3670-3cfa-4cec-8f6b-2518130719fb {
    /* Definition of color scheme common for light and dark mode */
    --sklearn-color-text: black;
    --sklearn-color-line: gray;
    /* Definition of color scheme for objects */
    --sklearn-color-level-0: #fff5e6;
    --sklearn-color-level-1: #f6e4d2;
    --sklearn-color-level-2: #ffe0b3;
    --sklearn-color-level-3: chocolate;

    /* Specific color for light theme */
    --sklearn-color-text-on-default-background: var(--theme-code-foreground, var(--jp-content-font-color1, black));
    --sklearn-color-background: var(--theme-background, var(--jp-layout-color0, white));
    --sklearn-color-border-box: var(--theme-code-foreground, var(--jp-content-font-color1, black));
    --sklearn-color-icon: #696969;

    @media (prefers-color-scheme: dark) {
      /* Redefinition of color scheme for dark theme */
      --sklearn-color-text-on-default-background: var(--theme-code-foreground, var(--jp-content-font-color1, white));
      --sklearn-color-background: var(--theme-background, var(--jp-layout-color0, #111));
      --sklearn-color-border-box: var(--theme-code-foreground, var(--jp-content-font-color1, white));
      --sklearn-color-icon: #878787;
    }
  }

  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb {
    color: var(--sklearn-color-text);
  }

  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb pre {
    padding: 0;
  }

  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb input.sk-hidden--visually {
    border: 0;
    clip: rect(1px 1px 1px 1px);
    clip: rect(1px, 1px, 1px, 1px);
    height: 1px;
    margin: -1px;
    overflow: hidden;
    padding: 0;
    position: absolute;
    width: 1px;
  }

  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb div.sk-dashed-wrapped {
    border: 1px dashed var(--sklearn-color-line);
    margin: 0 0.4em 0.5em 0.4em;
    box-sizing: border-box;
    padding-bottom: 0.4em;
    background-color: var(--sklearn-color-background);
  }

  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb div.sk-container {
    /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
       but bootstrap.min.css set `[hidden] { display: none !important; }`
       so we also need the `!important` here to be able to override the
       default hidden behavior on the sphinx rendered scikit-learn.org.
       See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
    display: inline-block !important;
    position: relative;
  }

  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb div.sk-text-repr-fallback {
    display: none;
  }

  div.sk-parallel-item,
  div.sk-serial,
  div.sk-item {
    /* draw centered vertical line to link estimators */
    background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
    background-size: 2px 100%;
    background-repeat: no-repeat;
    background-position: center center;
  }

  /* Parallel-specific style estimator block */

  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb div.sk-parallel-item::after {
    content: "";
    width: 100%;
    border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
    flex-grow: 1;
  }

  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb div.sk-parallel {
    display: flex;
    align-items: stretch;
    justify-content: center;
    background-color: var(--sklearn-color-background);
    position: relative;
  }

  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb div.sk-parallel-item {
    display: flex;
    flex-direction: column;
  }

  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb div.sk-parallel-item:first-child::after {
    align-self: flex-end;
    width: 50%;
  }

  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb div.sk-parallel-item:last-child::after {
    align-self: flex-start;
    width: 50%;
  }

  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb div.sk-parallel-item:only-child::after {
    width: 0;
  }

  /* Serial-specific style estimator block */

  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb div.sk-serial {
    display: flex;
    flex-direction: column;
    align-items: center;
    background-color: var(--sklearn-color-background);
    padding-right: 1em;
    padding-left: 1em;
  }


  /* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
  clickable and can be expanded/collapsed.
  - Pipeline and ColumnTransformer use this feature and define the default style
  - Estimators will overwrite some part of the style using the `sk-estimator` class
  */

  /* Pipeline and ColumnTransformer style (default) */

  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb div.sk-toggleable {
    /* Default theme specific background. It is overwritten whether we have a
    specific estimator or a Pipeline/ColumnTransformer */
    background-color: var(--sklearn-color-background);
  }

  /* Toggleable label */
  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb label.sk-toggleable__label {
    cursor: pointer;
    display: block;
    width: 100%;
    margin-bottom: 0;
    padding: 0.5em;
    box-sizing: border-box;
    text-align: center;
  }

  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb label.sk-toggleable__label-arrow:before {
    /* Arrow on the left of the label */
    content: "‚ñ∏";
    float: left;
    margin-right: 0.25em;
    color: var(--sklearn-color-icon);
  }

  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb label.sk-toggleable__label-arrow:hover:before {
    color: var(--sklearn-color-text);
  }

  /* Toggleable content - dropdown */

  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb div.sk-toggleable__content {
    max-height: 0;
    max-width: 0;
    overflow: hidden;
    text-align: left;
    background-color: var(--sklearn-color-level-0);
  }

  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb div.sk-toggleable__content pre {
    margin: 0.2em;
    border-radius: 0.25em;
    color: var(--sklearn-color-text);
    background-color: var(--sklearn-color-level-0);
  }

  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb input.sk-toggleable__control:checked~div.sk-toggleable__content {
    /* Expand drop-down */
    max-height: 200px;
    max-width: 100%;
    overflow: auto;
  }

  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
    content: "‚ñæ";
  }

  /* Pipeline/ColumnTransformer-specific style */

  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
    color: var(--sklearn-color-text);
    background-color: var(--sklearn-color-level-2);
  }

  /* Estimator-specific style */

  /* Colorize estimator box */
  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
    /* unfitted */
    background-color: var(--sklearn-color-level-2);
  }

  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb div.sk-label label.sk-toggleable__label,
  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb div.sk-label label {
    /* The background is the default theme color */
    color: var(--sklearn-color-text-on-default-background);
  }

  /* On hover, darken the color of the background */
  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb div.sk-label:hover label.sk-toggleable__label {
    color: var(--sklearn-color-text);
    background-color: var(--sklearn-color-level-2);
  }

  /* Estimator label */

  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb div.sk-label label {
    font-family: monospace;
    font-weight: bold;
    display: inline-block;
    line-height: 1.2em;
  }

  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb div.sk-label-container {
    text-align: center;
  }

  /* Estimator-specific */
  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb div.sk-estimator {
    font-family: monospace;
    border: 1px dotted var(--sklearn-color-border-box);
    border-radius: 0.25em;
    box-sizing: border-box;
    margin-bottom: 0.5em;
    background-color: var(--sklearn-color-level-0);
  }

  /* on hover */
  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb div.sk-estimator:hover {
    background-color: var(--sklearn-color-level-2);
  }

  /* Specification for estimator info */

  .sk-estimator-doc-link,
  a:link.sk-estimator-doc-link,
  a:visited.sk-estimator-doc-link {
    float: right;
    font-size: smaller;
    line-height: 1em;
    font-family: monospace;
    background-color: var(--sklearn-color-background);
    border-radius: 1em;
    height: 1em;
    width: 1em;
    text-decoration: none !important;
    margin-left: 1ex;
    border: var(--sklearn-color-level-1) 1pt solid;
    color: var(--sklearn-color-level-1);
  }

  /* On hover */
  div.sk-estimator:hover .sk-estimator-doc-link:hover,
  .sk-estimator-doc-link:hover,
  div.sk-label-container:hover .sk-estimator-doc-link:hover,
  .sk-estimator-doc-link:hover {
    background-color: var(--sklearn-color-level-3);
    color: var(--sklearn-color-background);
    text-decoration: none;
  }

  /* Span, style for the box shown on hovering the info icon */
  .sk-estimator-doc-link span {
    display: none;
    z-index: 9999;
    position: relative;
    font-weight: normal;
    right: .2ex;
    padding: .5ex;
    margin: .5ex;
    width: min-content;
    min-width: 20ex;
    max-width: 50ex;
    color: var(--sklearn-color-text);
    box-shadow: 2pt 2pt 4pt #999;
    background: var(--sklearn-color-level-0);
    border: .5pt solid var(--sklearn-color-level-3);
  }

  .sk-estimator-doc-link:hover span {
    display: block;
  }

  /* "?"-specific style due to the `<a>` HTML tag */

  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb a.estimator_doc_link {
    float: right;
    font-size: 1rem;
    line-height: 1em;
    font-family: monospace;
    background-color: var(--sklearn-color-background);
    border-radius: 1rem;
    height: 1rem;
    width: 1rem;
    text-decoration: none;
    color: var(--sklearn-color-level-1);
    border: var(--sklearn-color-level-1) 1pt solid;
  }

  /* On hover */
  #sk-997b3670-3cfa-4cec-8f6b-2518130719fb a.estimator_doc_link:hover {
    background-color: var(--sklearn-color-level-3);
    color: var(--sklearn-color-background);
    text-decoration: none;
  }
</style><div id="sk-997b3670-3cfa-4cec-8f6b-2518130719fb" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>Prophetverse(exogenous_effects=[('yearly_seasonality',
                                 LinearFourierSeasonality(effect_mode='multiplicative',
                                                          fourier_terms_list=[5],
                                                          freq='D',
                                                          prior_scale=0.1,
                                                          sp_list=[365.25]),
                                 None),
                                ('weekly_seasonality',
                                 LinearFourierSeasonality(effect_mode='multiplicative',
                                                          fourier_terms_list=[3],
                                                          freq='D',
                                                          prior_scale=0.05,
                                                          sp_list=[7]),
                                 None),
                                ('ad_spend_search',
                                 LiftExp...
2002-07-03  1.053316   25537.869750   38025.254409
2004-09-27  1.010456    8523.749415   11037.466255
2000-10-25  0.980559   50964.957119   65038.733878
2002-11-02  1.355164    1195.765141    1603.253926,
                                                          prior_scale=0.05),
                                 'ad_spend_social_media')],
             inference_engine=MAPInferenceEngine(num_steps=5000,
                                                 optimizer=LBFGSSolver(max_linesearch_steps=300,
                                                                       memory_size=300)),
             trend=PiecewiseLinearTrend(changepoint_interval=100))</pre><b>Please rerun this cell to show the HTML repr or trust the notebook.</b></div><div class="sk-container" hidden=""><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('fd5187ad-8dd4-4231-8a0d-c12ac650cb64')" type="checkbox"><label for="UUID('fd5187ad-8dd4-4231-8a0d-c12ac650cb64')" class="sk-toggleable__label sk-toggleable__label-arrow">Prophetverse</label><div class="sk-toggleable__content"><pre>Prophetverse(exogenous_effects=[('yearly_seasonality',
                                 LinearFourierSeasonality(effect_mode='multiplicative',
                                                          fourier_terms_list=[5],
                                                          freq='D',
                                                          prior_scale=0.1,
                                                          sp_list=[365.25]),
                                 None),
                                ('weekly_seasonality',
                                 LinearFourierSeasonality(effect_mode='multiplicative',
                                                          fourier_terms_list=[3],
                                                          freq='D',
                                                          prior_scale=0.05,
                                                          sp_list=[7]),
                                 None),
                                ('ad_spend_search',
                                 LiftExp...
2002-07-03  1.053316   25537.869750   38025.254409
2004-09-27  1.010456    8523.749415   11037.466255
2000-10-25  0.980559   50964.957119   65038.733878
2002-11-02  1.355164    1195.765141    1603.253926,
                                                          prior_scale=0.05),
                                 'ad_spend_social_media')],
             inference_engine=MAPInferenceEngine(num_steps=5000,
                                                 optimizer=LBFGSSolver(max_linesearch_steps=300,
                                                                       memory_size=300)),
             trend=PiecewiseLinearTrend(changepoint_interval=100))</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><label>effects</label></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('d023dc82-71fb-446b-8581-02de6268497e')" type="checkbox"><label for="UUID('d023dc82-71fb-446b-8581-02de6268497e')" class="sk-toggleable__label sk-toggleable__label-arrow">PiecewiseLinearTrend</label><div class="sk-toggleable__content"><pre>PiecewiseLinearTrend(changepoint_interval=100)</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('de321d88-2b1e-4b8e-8719-db7ebebba920')" type="checkbox"><label for="UUID('de321d88-2b1e-4b8e-8719-db7ebebba920')" class="sk-toggleable__label sk-toggleable__label-arrow">LinearFourierSeasonality</label><div class="sk-toggleable__content"><pre>LinearFourierSeasonality(effect_mode='multiplicative', fourier_terms_list=[5],
                         freq='D', prior_scale=0.1, sp_list=[365.25])</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('4202ee75-5488-4bcf-b8cd-e7ede1571269')" type="checkbox"><label for="UUID('4202ee75-5488-4bcf-b8cd-e7ede1571269')" class="sk-toggleable__label sk-toggleable__label-arrow">LinearFourierSeasonality</label><div class="sk-toggleable__content"><pre>LinearFourierSeasonality(effect_mode='multiplicative', fourier_terms_list=[3],
                         freq='D', prior_scale=0.05, sp_list=[7])</pre></div></div></div><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('5ea5549a-0dc8-47b3-b34b-f2cc1ad2e14a')" type="checkbox"><label for="UUID('5ea5549a-0dc8-47b3-b34b-f2cc1ad2e14a')" class="sk-toggleable__label sk-toggleable__label-arrow">ad_spend_search</label><div class="sk-toggleable__content"><pre>LiftExperimentLikelihood(effect=ChainedEffects(steps=[('adstock',
                                                       GeometricAdstockEffect()),
                                                      ('saturation',
                                                       HillEffect(effect_mode='additive',
                                                                  half_max_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b85cc890 with batch shape () and event shape ()&gt;,
                                                                  input_scale=1000000.0,
                                                                  max_effect_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94...
2001-02-02  1.212479   67857.642170   88071.282712
2001-05-21  1.178636   71337.927880   93445.016948
2003-05-06  0.644814   25609.287364   21843.082411
2000-07-31  1.012828   92617.293678   85766.681515
2002-07-03  1.267595   57443.596207   66595.562035
2004-09-27  1.369890   41546.443755   50176.823146
2000-10-25  0.985062   72757.343228   70195.986606
2002-11-02  0.834577   19043.272758   18373.397899,
                         prior_scale=0.05)</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('48668fbe-32c9-4eb4-9fe9-6d21418aee71')" type="checkbox"><label for="UUID('48668fbe-32c9-4eb4-9fe9-6d21418aee71')" class="sk-toggleable__label sk-toggleable__label-arrow">effect: ChainedEffects</label><div class="sk-toggleable__content"><pre>ChainedEffects(steps=[('adstock', GeometricAdstockEffect()),
                      ('saturation',
                       HillEffect(effect_mode='additive',
                                  half_max_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b85cc890 with batch shape () and event shape ()&gt;,
                                  input_scale=1000000.0,
                                  max_effect_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b8150450 with batch shape () and event shape ()&gt;,
                                  slope_prior=&lt;numpyro.distributions.continuous.InverseGamma object at 0x7f9479f14310 with batch shape () and event shape ()&gt;))])</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('d9c8057e-0b96-4d27-956f-28fa3e56c7c9')" type="checkbox"><label for="UUID('d9c8057e-0b96-4d27-956f-28fa3e56c7c9')" class="sk-toggleable__label sk-toggleable__label-arrow">GeometricAdstockEffect</label><div class="sk-toggleable__content"><pre>GeometricAdstockEffect()</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('fa08701f-4d05-41d3-b7c2-70297eed97f1')" type="checkbox"><label for="UUID('fa08701f-4d05-41d3-b7c2-70297eed97f1')" class="sk-toggleable__label sk-toggleable__label-arrow">HillEffect</label><div class="sk-toggleable__content"><pre>HillEffect(effect_mode='additive',
           half_max_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b85cc890 with batch shape () and event shape ()&gt;,
           input_scale=1000000.0,
           max_effect_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b8150450 with batch shape () and event shape ()&gt;,
           slope_prior=&lt;numpyro.distributions.continuous.InverseGamma object at 0x7f9479f14310 with batch shape () and event shape ()&gt;)</pre></div></div></div></div></div></div></div></div></div></div><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('b8ccc432-d18c-4a32-9af5-abef88888ac4')" type="checkbox"><label for="UUID('b8ccc432-d18c-4a32-9af5-abef88888ac4')" class="sk-toggleable__label sk-toggleable__label-arrow">ad_spend_social_media</label><div class="sk-toggleable__content"><pre>LiftExperimentLikelihood(effect=ChainedEffects(steps=[('adstock',
                                                       GeometricAdstockEffect()),
                                                      ('saturation',
                                                       HillEffect(effect_mode='additive',
                                                                  half_max_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b85cc890 with batch shape () and event shape ()&gt;,
                                                                  input_scale=1000000.0,
                                                                  max_effect_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94...
2001-02-02  1.085461   38129.336619   47626.107330
2001-05-21  0.961702   50010.574434   73721.957893
2003-05-06  1.099837    2893.044038    2702.425237
2000-07-31  1.028477  105196.357631  125200.174092
2002-07-03  1.053316   25537.869750   38025.254409
2004-09-27  1.010456    8523.749415   11037.466255
2000-10-25  0.980559   50964.957119   65038.733878
2002-11-02  1.355164    1195.765141    1603.253926,
                         prior_scale=0.05)</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('1d6fc581-7369-4161-af5d-1f94e183dc04')" type="checkbox"><label for="UUID('1d6fc581-7369-4161-af5d-1f94e183dc04')" class="sk-toggleable__label sk-toggleable__label-arrow">effect: ChainedEffects</label><div class="sk-toggleable__content"><pre>ChainedEffects(steps=[('adstock', GeometricAdstockEffect()),
                      ('saturation',
                       HillEffect(effect_mode='additive',
                                  half_max_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b85cc890 with batch shape () and event shape ()&gt;,
                                  input_scale=1000000.0,
                                  max_effect_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b8150450 with batch shape () and event shape ()&gt;,
                                  slope_prior=&lt;numpyro.distributions.continuous.InverseGamma object at 0x7f9479f14310 with batch shape () and event shape ()&gt;))])</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('f1d9aaea-be46-4717-be6c-0631e8ae9c71')" type="checkbox"><label for="UUID('f1d9aaea-be46-4717-be6c-0631e8ae9c71')" class="sk-toggleable__label sk-toggleable__label-arrow">GeometricAdstockEffect</label><div class="sk-toggleable__content"><pre>GeometricAdstockEffect()</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('ae87dd71-49e1-4895-a283-839bf3011aca')" type="checkbox"><label for="UUID('ae87dd71-49e1-4895-a283-839bf3011aca')" class="sk-toggleable__label sk-toggleable__label-arrow">HillEffect</label><div class="sk-toggleable__content"><pre>HillEffect(effect_mode='additive',
           half_max_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b85cc890 with batch shape () and event shape ()&gt;,
           input_scale=1000000.0,
           max_effect_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b8150450 with batch shape () and event shape ()&gt;,
           slope_prior=&lt;numpyro.distributions.continuous.InverseGamma object at 0x7f9479f14310 with batch shape () and event shape ()&gt;)</pre></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><label>inference_engine</label></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('5d8dbff2-61fb-4437-8035-044aa33fc37b')" type="checkbox"><label for="UUID('5d8dbff2-61fb-4437-8035-044aa33fc37b')" class="sk-toggleable__label sk-toggleable__label-arrow">MAPInferenceEngine</label><div class="sk-toggleable__content"><pre>MAPInferenceEngine(num_steps=5000,
                   optimizer=LBFGSSolver(max_linesearch_steps=300,
                                         memory_size=300))</pre></div></div></div></div></div></div></div></div></div></div>
</div>
</div>
<div id="b9c6238e" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>components_lift <span class="op">=</span> model_lift.predict_components(X<span class="op">=</span>X, fh<span class="op">=</span>X.index)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>components_lift.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ad_spend_search</th>
<th data-quarto-table-cell-role="th">ad_spend_social_media</th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">obs</th>
<th data-quarto-table-cell-role="th">trend</th>
<th data-quarto-table-cell-role="th">weekly_seasonality</th>
<th data-quarto-table-cell-role="th">yearly_seasonality</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-01-01</td>
<td>6.896103e+06</td>
<td>3.175256e+06</td>
<td>1.048023e+07</td>
<td>1.045961e+07</td>
<td>440331.000733</td>
<td>18678.628404</td>
<td>-50136.112163</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2000-01-02</td>
<td>7.567685e+06</td>
<td>3.223124e+06</td>
<td>1.119077e+07</td>
<td>1.114659e+07</td>
<td>449501.858237</td>
<td>793.004783</td>
<td>-50332.632576</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-01-03</td>
<td>7.681280e+06</td>
<td>3.232448e+06</td>
<td>1.132774e+07</td>
<td>1.138590e+07</td>
<td>458672.715742</td>
<td>5733.320420</td>
<td>-50390.259594</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2000-01-04</td>
<td>7.702655e+06</td>
<td>3.238583e+06</td>
<td>1.133668e+07</td>
<td>1.129631e+07</td>
<td>467843.573246</td>
<td>-22096.402845</td>
<td>-50304.197196</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-01-05</td>
<td>7.675790e+06</td>
<td>3.234881e+06</td>
<td>1.133471e+07</td>
<td>1.128616e+07</td>
<td>477014.430751</td>
<td>-2907.612721</td>
<td>-50069.990557</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="e9f0473d" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>), ncols<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, channel <span class="kw">in</span> <span class="bu">zip</span>(axs, [<span class="st">"ad_spend_search"</span>, <span class="st">"ad_spend_social_media"</span>]):</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    ax.scatter(</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>        X[channel],</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>        y_pred_components[channel],</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">"Baseline"</span>,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.6</span>,</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        s<span class="op">=</span><span class="dv">50</span>,</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    ax.scatter(</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>        X[channel],</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>        components_lift[channel],</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">"With Lift Test"</span>,</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.6</span>,</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>        s<span class="op">=</span><span class="dv">50</span>,</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    ax.plot(</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>        X[channel],</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>        true_components[channel],</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">"True"</span>,</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"black"</span>,</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>        linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    ax.<span class="bu">set</span>(</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>channel<span class="sc">}</span><span class="ss"> Predicted Effects"</span>,</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>        xlabel<span class="op">=</span><span class="st">"Daily Spend"</span>,</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>        ylabel<span class="op">=</span><span class="st">"Incremental Effect"</span>,</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    ax.axhline(<span class="dv">0</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, color<span class="op">=</span><span class="st">"gray"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    ax.legend()</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fitting_and_calibration_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Much better, right? And it was implemented with a really modular and flexible code. You could wrap any effect with <code>LiftExperimentLikelihood</code> to add lift test data to guide its behaviour. Nevertheless, this is not the end of the story.</p>
</section>
<section id="add-attribution-signals-with-exactlikelihood" class="level3">
<h3 class="anchored" data-anchor-id="add-attribution-signals-with-exactlikelihood">2.3 Add Attribution Signals with ExactLikelihood</h3>
<p>Attribution models can provide <strong>daily signals</strong>. If available, you can incorporate them by adding another likelihood term via <code>ExactLikelihood</code>.</p>
<p>We create a synthetic attribution signal by multiplying the true effect with a random noise factor.</p>
<div id="235c07f4" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prophetverse.effects <span class="im">import</span> ExactLikelihood</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.default_rng(<span class="dv">42</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate attribution signals for search and social media channels</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>attr_search <span class="op">=</span> true_components[[<span class="st">"ad_spend_search"</span>]] <span class="op">*</span> rng.normal(</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>, <span class="fl">0.1</span>, size<span class="op">=</span>(<span class="bu">len</span>(y), <span class="dv">1</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>attr_social <span class="op">=</span> true_components[[<span class="st">"ad_spend_social_media"</span>]] <span class="op">*</span> rng.normal(</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>, <span class="fl">0.1</span>, size<span class="op">=</span>(<span class="bu">len</span>(y), <span class="dv">1</span>)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first few rows of the social media attribution signal</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>attr_social.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ad_spend_social_media</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-01-01</td>
<td>2.171846e+06</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2000-01-02</td>
<td>2.625088e+06</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-01-03</td>
<td>2.983027e+06</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2000-01-04</td>
<td>2.836756e+06</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2000-01-05</td>
<td>2.520331e+06</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="98424ade" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>model_umm <span class="op">=</span> model_lift.clone()</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>model_umm.set_params(</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    exogenous_effects<span class="op">=</span>model_lift.get_params()[<span class="st">"exogenous_effects"</span>]</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> [</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        (</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">"attribution_search"</span>,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>            ExactLikelihood(<span class="st">"ad_spend_search"</span>, attr_search, <span class="fl">0.01</span>),</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>            <span class="va">None</span>,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>        (</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">"attribution_social_media"</span>,</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>            ExactLikelihood(<span class="st">"ad_spend_social_media"</span>, attr_social, <span class="fl">0.01</span>),</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>            <span class="va">None</span>,</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>model_umm.fit(y<span class="op">=</span>y, X<span class="op">=</span>X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<style>#sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 {
    /* Definition of color scheme common for light and dark mode */
    --sklearn-color-text: black;
    --sklearn-color-line: gray;
    /* Definition of color scheme for objects */
    --sklearn-color-level-0: #fff5e6;
    --sklearn-color-level-1: #f6e4d2;
    --sklearn-color-level-2: #ffe0b3;
    --sklearn-color-level-3: chocolate;

    /* Specific color for light theme */
    --sklearn-color-text-on-default-background: var(--theme-code-foreground, var(--jp-content-font-color1, black));
    --sklearn-color-background: var(--theme-background, var(--jp-layout-color0, white));
    --sklearn-color-border-box: var(--theme-code-foreground, var(--jp-content-font-color1, black));
    --sklearn-color-icon: #696969;

    @media (prefers-color-scheme: dark) {
      /* Redefinition of color scheme for dark theme */
      --sklearn-color-text-on-default-background: var(--theme-code-foreground, var(--jp-content-font-color1, white));
      --sklearn-color-background: var(--theme-background, var(--jp-layout-color0, #111));
      --sklearn-color-border-box: var(--theme-code-foreground, var(--jp-content-font-color1, white));
      --sklearn-color-icon: #878787;
    }
  }

  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 {
    color: var(--sklearn-color-text);
  }

  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 pre {
    padding: 0;
  }

  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 input.sk-hidden--visually {
    border: 0;
    clip: rect(1px 1px 1px 1px);
    clip: rect(1px, 1px, 1px, 1px);
    height: 1px;
    margin: -1px;
    overflow: hidden;
    padding: 0;
    position: absolute;
    width: 1px;
  }

  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 div.sk-dashed-wrapped {
    border: 1px dashed var(--sklearn-color-line);
    margin: 0 0.4em 0.5em 0.4em;
    box-sizing: border-box;
    padding-bottom: 0.4em;
    background-color: var(--sklearn-color-background);
  }

  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 div.sk-container {
    /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
       but bootstrap.min.css set `[hidden] { display: none !important; }`
       so we also need the `!important` here to be able to override the
       default hidden behavior on the sphinx rendered scikit-learn.org.
       See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
    display: inline-block !important;
    position: relative;
  }

  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 div.sk-text-repr-fallback {
    display: none;
  }

  div.sk-parallel-item,
  div.sk-serial,
  div.sk-item {
    /* draw centered vertical line to link estimators */
    background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
    background-size: 2px 100%;
    background-repeat: no-repeat;
    background-position: center center;
  }

  /* Parallel-specific style estimator block */

  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 div.sk-parallel-item::after {
    content: "";
    width: 100%;
    border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
    flex-grow: 1;
  }

  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 div.sk-parallel {
    display: flex;
    align-items: stretch;
    justify-content: center;
    background-color: var(--sklearn-color-background);
    position: relative;
  }

  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 div.sk-parallel-item {
    display: flex;
    flex-direction: column;
  }

  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 div.sk-parallel-item:first-child::after {
    align-self: flex-end;
    width: 50%;
  }

  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 div.sk-parallel-item:last-child::after {
    align-self: flex-start;
    width: 50%;
  }

  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 div.sk-parallel-item:only-child::after {
    width: 0;
  }

  /* Serial-specific style estimator block */

  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 div.sk-serial {
    display: flex;
    flex-direction: column;
    align-items: center;
    background-color: var(--sklearn-color-background);
    padding-right: 1em;
    padding-left: 1em;
  }


  /* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
  clickable and can be expanded/collapsed.
  - Pipeline and ColumnTransformer use this feature and define the default style
  - Estimators will overwrite some part of the style using the `sk-estimator` class
  */

  /* Pipeline and ColumnTransformer style (default) */

  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 div.sk-toggleable {
    /* Default theme specific background. It is overwritten whether we have a
    specific estimator or a Pipeline/ColumnTransformer */
    background-color: var(--sklearn-color-background);
  }

  /* Toggleable label */
  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 label.sk-toggleable__label {
    cursor: pointer;
    display: block;
    width: 100%;
    margin-bottom: 0;
    padding: 0.5em;
    box-sizing: border-box;
    text-align: center;
  }

  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 label.sk-toggleable__label-arrow:before {
    /* Arrow on the left of the label */
    content: "‚ñ∏";
    float: left;
    margin-right: 0.25em;
    color: var(--sklearn-color-icon);
  }

  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 label.sk-toggleable__label-arrow:hover:before {
    color: var(--sklearn-color-text);
  }

  /* Toggleable content - dropdown */

  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 div.sk-toggleable__content {
    max-height: 0;
    max-width: 0;
    overflow: hidden;
    text-align: left;
    background-color: var(--sklearn-color-level-0);
  }

  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 div.sk-toggleable__content pre {
    margin: 0.2em;
    border-radius: 0.25em;
    color: var(--sklearn-color-text);
    background-color: var(--sklearn-color-level-0);
  }

  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 input.sk-toggleable__control:checked~div.sk-toggleable__content {
    /* Expand drop-down */
    max-height: 200px;
    max-width: 100%;
    overflow: auto;
  }

  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
    content: "‚ñæ";
  }

  /* Pipeline/ColumnTransformer-specific style */

  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
    color: var(--sklearn-color-text);
    background-color: var(--sklearn-color-level-2);
  }

  /* Estimator-specific style */

  /* Colorize estimator box */
  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
    /* unfitted */
    background-color: var(--sklearn-color-level-2);
  }

  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 div.sk-label label.sk-toggleable__label,
  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 div.sk-label label {
    /* The background is the default theme color */
    color: var(--sklearn-color-text-on-default-background);
  }

  /* On hover, darken the color of the background */
  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 div.sk-label:hover label.sk-toggleable__label {
    color: var(--sklearn-color-text);
    background-color: var(--sklearn-color-level-2);
  }

  /* Estimator label */

  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 div.sk-label label {
    font-family: monospace;
    font-weight: bold;
    display: inline-block;
    line-height: 1.2em;
  }

  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 div.sk-label-container {
    text-align: center;
  }

  /* Estimator-specific */
  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 div.sk-estimator {
    font-family: monospace;
    border: 1px dotted var(--sklearn-color-border-box);
    border-radius: 0.25em;
    box-sizing: border-box;
    margin-bottom: 0.5em;
    background-color: var(--sklearn-color-level-0);
  }

  /* on hover */
  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 div.sk-estimator:hover {
    background-color: var(--sklearn-color-level-2);
  }

  /* Specification for estimator info */

  .sk-estimator-doc-link,
  a:link.sk-estimator-doc-link,
  a:visited.sk-estimator-doc-link {
    float: right;
    font-size: smaller;
    line-height: 1em;
    font-family: monospace;
    background-color: var(--sklearn-color-background);
    border-radius: 1em;
    height: 1em;
    width: 1em;
    text-decoration: none !important;
    margin-left: 1ex;
    border: var(--sklearn-color-level-1) 1pt solid;
    color: var(--sklearn-color-level-1);
  }

  /* On hover */
  div.sk-estimator:hover .sk-estimator-doc-link:hover,
  .sk-estimator-doc-link:hover,
  div.sk-label-container:hover .sk-estimator-doc-link:hover,
  .sk-estimator-doc-link:hover {
    background-color: var(--sklearn-color-level-3);
    color: var(--sklearn-color-background);
    text-decoration: none;
  }

  /* Span, style for the box shown on hovering the info icon */
  .sk-estimator-doc-link span {
    display: none;
    z-index: 9999;
    position: relative;
    font-weight: normal;
    right: .2ex;
    padding: .5ex;
    margin: .5ex;
    width: min-content;
    min-width: 20ex;
    max-width: 50ex;
    color: var(--sklearn-color-text);
    box-shadow: 2pt 2pt 4pt #999;
    background: var(--sklearn-color-level-0);
    border: .5pt solid var(--sklearn-color-level-3);
  }

  .sk-estimator-doc-link:hover span {
    display: block;
  }

  /* "?"-specific style due to the `<a>` HTML tag */

  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 a.estimator_doc_link {
    float: right;
    font-size: 1rem;
    line-height: 1em;
    font-family: monospace;
    background-color: var(--sklearn-color-background);
    border-radius: 1rem;
    height: 1rem;
    width: 1rem;
    text-decoration: none;
    color: var(--sklearn-color-level-1);
    border: var(--sklearn-color-level-1) 1pt solid;
  }

  /* On hover */
  #sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826 a.estimator_doc_link:hover {
    background-color: var(--sklearn-color-level-3);
    color: var(--sklearn-color-background);
    text-decoration: none;
  }
</style><div id="sk-955b5ab2-86bd-4aa4-ab91-055ec7aa4826" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>Prophetverse(exogenous_effects=[('yearly_seasonality',
                                 LinearFourierSeasonality(effect_mode='multiplicative',
                                                          fourier_terms_list=[5],
                                                          freq='D',
                                                          prior_scale=0.1,
                                                          sp_list=[365.25]),
                                 None),
                                ('weekly_seasonality',
                                 LinearFourierSeasonality(effect_mode='multiplicative',
                                                          fourier_terms_list=[3],
                                                          freq='D',
                                                          prior_scale=0.05,
                                                          sp_list=[7]),
                                 None),
                                ('ad_spend_search',
                                 LiftExp...
2000-01-04           2.836756e+06
2000-01-05           2.520331e+06
...                           ...
2004-12-28           1.012305e+06
2004-12-29           1.108765e+06
2004-12-30           1.070854e+06
2004-12-31           1.027756e+06
2005-01-01           1.012141e+06

[1828 rows x 1 columns]),
                                 None)],
             inference_engine=MAPInferenceEngine(num_steps=5000,
                                                 optimizer=LBFGSSolver(max_linesearch_steps=300,
                                                                       memory_size=300)),
             trend=PiecewiseLinearTrend(changepoint_interval=100))</pre><b>Please rerun this cell to show the HTML repr or trust the notebook.</b></div><div class="sk-container" hidden=""><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('c9dc190c-8841-46cf-b27e-a0714925c460')" type="checkbox"><label for="UUID('c9dc190c-8841-46cf-b27e-a0714925c460')" class="sk-toggleable__label sk-toggleable__label-arrow">Prophetverse</label><div class="sk-toggleable__content"><pre>Prophetverse(exogenous_effects=[('yearly_seasonality',
                                 LinearFourierSeasonality(effect_mode='multiplicative',
                                                          fourier_terms_list=[5],
                                                          freq='D',
                                                          prior_scale=0.1,
                                                          sp_list=[365.25]),
                                 None),
                                ('weekly_seasonality',
                                 LinearFourierSeasonality(effect_mode='multiplicative',
                                                          fourier_terms_list=[3],
                                                          freq='D',
                                                          prior_scale=0.05,
                                                          sp_list=[7]),
                                 None),
                                ('ad_spend_search',
                                 LiftExp...
2000-01-04           2.836756e+06
2000-01-05           2.520331e+06
...                           ...
2004-12-28           1.012305e+06
2004-12-29           1.108765e+06
2004-12-30           1.070854e+06
2004-12-31           1.027756e+06
2005-01-01           1.012141e+06

[1828 rows x 1 columns]),
                                 None)],
             inference_engine=MAPInferenceEngine(num_steps=5000,
                                                 optimizer=LBFGSSolver(max_linesearch_steps=300,
                                                                       memory_size=300)),
             trend=PiecewiseLinearTrend(changepoint_interval=100))</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><label>effects</label></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('ad5c1bcb-7669-4647-b514-73e186c2a36c')" type="checkbox"><label for="UUID('ad5c1bcb-7669-4647-b514-73e186c2a36c')" class="sk-toggleable__label sk-toggleable__label-arrow">PiecewiseLinearTrend</label><div class="sk-toggleable__content"><pre>PiecewiseLinearTrend(changepoint_interval=100)</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('c8fe05ca-59b4-41a6-bf6a-a2b70a3cdde5')" type="checkbox"><label for="UUID('c8fe05ca-59b4-41a6-bf6a-a2b70a3cdde5')" class="sk-toggleable__label sk-toggleable__label-arrow">LinearFourierSeasonality</label><div class="sk-toggleable__content"><pre>LinearFourierSeasonality(effect_mode='multiplicative', fourier_terms_list=[5],
                         freq='D', prior_scale=0.1, sp_list=[365.25])</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('074b75c7-c993-44b0-b28c-f8fc667b2fe7')" type="checkbox"><label for="UUID('074b75c7-c993-44b0-b28c-f8fc667b2fe7')" class="sk-toggleable__label sk-toggleable__label-arrow">LinearFourierSeasonality</label><div class="sk-toggleable__content"><pre>LinearFourierSeasonality(effect_mode='multiplicative', fourier_terms_list=[3],
                         freq='D', prior_scale=0.05, sp_list=[7])</pre></div></div></div><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('2f94e7c5-ead9-452d-a4b8-8c4611cf00f3')" type="checkbox"><label for="UUID('2f94e7c5-ead9-452d-a4b8-8c4611cf00f3')" class="sk-toggleable__label sk-toggleable__label-arrow">ad_spend_search</label><div class="sk-toggleable__content"><pre>LiftExperimentLikelihood(effect=ChainedEffects(steps=[('adstock',
                                                       GeometricAdstockEffect()),
                                                      ('saturation',
                                                       HillEffect(effect_mode='additive',
                                                                  half_max_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b85cc890 with batch shape () and event shape ()&gt;,
                                                                  input_scale=1000000.0,
                                                                  max_effect_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94...
2001-02-02  1.212479   67857.642170   88071.282712
2001-05-21  1.178636   71337.927880   93445.016948
2003-05-06  0.644814   25609.287364   21843.082411
2000-07-31  1.012828   92617.293678   85766.681515
2002-07-03  1.267595   57443.596207   66595.562035
2004-09-27  1.369890   41546.443755   50176.823146
2000-10-25  0.985062   72757.343228   70195.986606
2002-11-02  0.834577   19043.272758   18373.397899,
                         prior_scale=0.05)</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('ce378bda-6342-44df-92c3-fdb2af97f978')" type="checkbox"><label for="UUID('ce378bda-6342-44df-92c3-fdb2af97f978')" class="sk-toggleable__label sk-toggleable__label-arrow">effect: ChainedEffects</label><div class="sk-toggleable__content"><pre>ChainedEffects(steps=[('adstock', GeometricAdstockEffect()),
                      ('saturation',
                       HillEffect(effect_mode='additive',
                                  half_max_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b85cc890 with batch shape () and event shape ()&gt;,
                                  input_scale=1000000.0,
                                  max_effect_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b8150450 with batch shape () and event shape ()&gt;,
                                  slope_prior=&lt;numpyro.distributions.continuous.InverseGamma object at 0x7f9479f14310 with batch shape () and event shape ()&gt;))])</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('10888436-2da1-4b60-9293-b95003493a46')" type="checkbox"><label for="UUID('10888436-2da1-4b60-9293-b95003493a46')" class="sk-toggleable__label sk-toggleable__label-arrow">GeometricAdstockEffect</label><div class="sk-toggleable__content"><pre>GeometricAdstockEffect()</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('7876de7b-4fd6-4adf-aa72-ab743ded2842')" type="checkbox"><label for="UUID('7876de7b-4fd6-4adf-aa72-ab743ded2842')" class="sk-toggleable__label sk-toggleable__label-arrow">HillEffect</label><div class="sk-toggleable__content"><pre>HillEffect(effect_mode='additive',
           half_max_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b85cc890 with batch shape () and event shape ()&gt;,
           input_scale=1000000.0,
           max_effect_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b8150450 with batch shape () and event shape ()&gt;,
           slope_prior=&lt;numpyro.distributions.continuous.InverseGamma object at 0x7f9479f14310 with batch shape () and event shape ()&gt;)</pre></div></div></div></div></div></div></div></div></div></div><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('fbbd37f3-a27c-48d9-bedf-5dfbb6cff1e0')" type="checkbox"><label for="UUID('fbbd37f3-a27c-48d9-bedf-5dfbb6cff1e0')" class="sk-toggleable__label sk-toggleable__label-arrow">ad_spend_social_media</label><div class="sk-toggleable__content"><pre>LiftExperimentLikelihood(effect=ChainedEffects(steps=[('adstock',
                                                       GeometricAdstockEffect()),
                                                      ('saturation',
                                                       HillEffect(effect_mode='additive',
                                                                  half_max_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b85cc890 with batch shape () and event shape ()&gt;,
                                                                  input_scale=1000000.0,
                                                                  max_effect_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94...
2001-02-02  1.085461   38129.336619   47626.107330
2001-05-21  0.961702   50010.574434   73721.957893
2003-05-06  1.099837    2893.044038    2702.425237
2000-07-31  1.028477  105196.357631  125200.174092
2002-07-03  1.053316   25537.869750   38025.254409
2004-09-27  1.010456    8523.749415   11037.466255
2000-10-25  0.980559   50964.957119   65038.733878
2002-11-02  1.355164    1195.765141    1603.253926,
                         prior_scale=0.05)</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('d33f5cec-1c05-4da6-b1d7-2859accd637f')" type="checkbox"><label for="UUID('d33f5cec-1c05-4da6-b1d7-2859accd637f')" class="sk-toggleable__label sk-toggleable__label-arrow">effect: ChainedEffects</label><div class="sk-toggleable__content"><pre>ChainedEffects(steps=[('adstock', GeometricAdstockEffect()),
                      ('saturation',
                       HillEffect(effect_mode='additive',
                                  half_max_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b85cc890 with batch shape () and event shape ()&gt;,
                                  input_scale=1000000.0,
                                  max_effect_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b8150450 with batch shape () and event shape ()&gt;,
                                  slope_prior=&lt;numpyro.distributions.continuous.InverseGamma object at 0x7f9479f14310 with batch shape () and event shape ()&gt;))])</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('0980e95d-dabb-4cdf-8c35-18b77e9dbdff')" type="checkbox"><label for="UUID('0980e95d-dabb-4cdf-8c35-18b77e9dbdff')" class="sk-toggleable__label sk-toggleable__label-arrow">GeometricAdstockEffect</label><div class="sk-toggleable__content"><pre>GeometricAdstockEffect()</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('dc7c7398-a9db-4a13-976f-6e68b02dac5c')" type="checkbox"><label for="UUID('dc7c7398-a9db-4a13-976f-6e68b02dac5c')" class="sk-toggleable__label sk-toggleable__label-arrow">HillEffect</label><div class="sk-toggleable__content"><pre>HillEffect(effect_mode='additive',
           half_max_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b85cc890 with batch shape () and event shape ()&gt;,
           input_scale=1000000.0,
           max_effect_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f94b8150450 with batch shape () and event shape ()&gt;,
           slope_prior=&lt;numpyro.distributions.continuous.InverseGamma object at 0x7f9479f14310 with batch shape () and event shape ()&gt;)</pre></div></div></div></div></div></div></div></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('581c67e7-8bc8-44b9-9b36-212a85179dd8')" type="checkbox"><label for="UUID('581c67e7-8bc8-44b9-9b36-212a85179dd8')" class="sk-toggleable__label sk-toggleable__label-arrow">ExactLikelihood</label><div class="sk-toggleable__content"><pre>ExactLikelihood(effect_name='ad_spend_search', prior_scale=0.01,
                reference_df=            ad_spend_search
2000-01-01     8.682649e+06
2000-01-02     7.542228e+06
2000-01-03     9.091821e+06
2000-01-04     9.259557e+06
2000-01-05     6.785853e+06
...                     ...
2004-12-28     3.547301e+06
2004-12-29     2.771639e+06
2004-12-30     2.972279e+06
2004-12-31     3.226681e+06
2005-01-01     3.605501e+06

[1828 rows x 1 columns])</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('d700b8fd-df3b-4545-a887-8cf18e3202e0')" type="checkbox"><label for="UUID('d700b8fd-df3b-4545-a887-8cf18e3202e0')" class="sk-toggleable__label sk-toggleable__label-arrow">ExactLikelihood</label><div class="sk-toggleable__content"><pre>ExactLikelihood(effect_name='ad_spend_social_media', prior_scale=0.01,
                reference_df=            ad_spend_social_media
2000-01-01           2.171846e+06
2000-01-02           2.625088e+06
2000-01-03           2.983027e+06
2000-01-04           2.836756e+06
2000-01-05           2.520331e+06
...                           ...
2004-12-28           1.012305e+06
2004-12-29           1.108765e+06
2004-12-30           1.070854e+06
2004-12-31           1.027756e+06
2005-01-01           1.012141e+06

[1828 rows x 1 columns])</pre></div></div></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><label>inference_engine</label></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('6b13a070-9440-4529-bdbb-fc1172ecd221')" type="checkbox"><label for="UUID('6b13a070-9440-4529-bdbb-fc1172ecd221')" class="sk-toggleable__label sk-toggleable__label-arrow">MAPInferenceEngine</label><div class="sk-toggleable__content"><pre>MAPInferenceEngine(num_steps=5000,
                   optimizer=LBFGSSolver(max_linesearch_steps=300,
                                         memory_size=300))</pre></div></div></div></div></div></div></div></div></div></div>
</div>
</div>
<div id="18b4ed7b" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>components_umm <span class="op">=</span> model_umm.predict_components(X<span class="op">=</span>X, fh<span class="op">=</span>X.index)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">10</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, channel <span class="kw">in</span> <span class="bu">zip</span>(axs, [<span class="st">"ad_spend_search"</span>, <span class="st">"ad_spend_social_media"</span>]):</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    ax.scatter(X[channel], y_pred_components[channel], label<span class="op">=</span><span class="st">"Baseline"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    ax.scatter(X[channel], components_lift[channel], label<span class="op">=</span><span class="st">"With Lift Test"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    ax.scatter(X[channel], components_umm[channel], label<span class="op">=</span><span class="st">"With Attribution"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    ax.plot(X[channel], true_components[channel], label<span class="op">=</span><span class="st">"True Effect"</span>, color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    ax.set_title(channel)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    ax.legend()</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fitting_and_calibration_files/figure-html/cell-21-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Even better! And, due to sktime-like interface, wrapping and adding new effects is easy.</p>
</section>
</section>
<section id="final-thoughts-toward-unified-marketing-measurement" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts-toward-unified-marketing-measurement">Final Thoughts: Toward Unified Marketing Measurement</h2>
<p>‚úÖ <strong>What we learned</strong>:<br>
1. Adstock + saturation are essential to capture media dynamics.<br>
2. Good predictions ‚â† good attribution.<br>
3. Causal data like lift tests can <strong>correct</strong> misattribution.<br>
4. Attribution signals add further constraints.</p>
<p>üõ†Ô∏è <strong>Use this when</strong>:<br>
* Channels are correlated ‚Üí Use lift tests.<br>
* You have granular model output ‚Üí Add attribution likelihoods.</p>
<p>üß™ <strong>Model selection tip</strong>:<br>
Always validate <strong>causal logic</strong>, not just fit quality.</p>
<p>With Prophetverse, you can <strong>combine observational, experimental, and model-based signals</strong> into one coherent MMM+UMM pipeline.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "Óßã";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>