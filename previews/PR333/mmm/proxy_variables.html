<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Using proxy variables to model latent effects, such as awareness">

<title>Awareness: Latent and Proxy Variables ‚Äì prophetverse</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../static/logo-removebg.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-4d9afe2b8d18ee9fa5d0d57b5ed4214d.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-3865a973c09a15e0c44ee0b269dc24ff.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-e1919d4f01ae46742eb95ea0d42ca841.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-3865a973c09a15e0c44ee0b269dc24ff.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 5,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<meta name="mermaid-theme" content="neutral">
<script src="../site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="../site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
<link rel="stylesheet" href="../reference/_styles-quartodoc.css">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../static/logo-removebg.png" alt="" class="navbar-logo light-content">
    <img src="../static/logo-removebg.png" alt="" class="navbar-logo dark-content">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">prophetverse</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-tutorials-üìö" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Tutorials üìö</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-tutorials-üìö">    
        <li>
    <a class="dropdown-item" href="../tutorials/univariate.html">
 <span class="dropdown-text">Univariate forecasting</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorials/tuning.html">
 <span class="dropdown-text">Hyperparameter tuning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorials/hierarchical.html">
 <span class="dropdown-text">Hierarchical Bayesian Model</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorials/count_data.html">
 <span class="dropdown-text">Count data forecasting</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-how-to-üõ†Ô∏è" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">How To üõ†Ô∏è</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-how-to-üõ†Ô∏è">    
        <li>
    <a class="dropdown-item" href="../howto/effect_api_intro.html">
 <span class="dropdown-text">Introduction to Effects</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../howto/custom_trend.html">
 <span class="dropdown-text">Custom trend</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../howto/custom_effects.html">
 <span class="dropdown-text">Custom exogenous effect</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../howto/composite_effects.html">
 <span class="dropdown-text">Creating composite effects</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../howto/beta_percentage_forecast.html">
 <span class="dropdown-text">Forecasting percentages</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../mmm"> 
<span class="menu-text">Marketing Mix Modeling üöÄ</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../the-theory.html"> 
<span class="menu-text">Mathematical Formulation üìñ</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../reference"> 
<span class="menu-text">API Reference</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">‚ú®</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-">    
        <li>
    <a class="dropdown-item" href="../prompts/custom_effects.html">
 <span class="dropdown-text">Custom Effect Prompt</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-github" role="link" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-bi-github">    
        <li>
    <a class="dropdown-item" href="https://github.com/felipeangelimvieira/prophetverse">
 <span class="dropdown-text">Source Code</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../development.html">
 <span class="dropdown-text">Development guide</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-discord" role="link" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-discord" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-bi-discord">    
        <li>
    <a class="dropdown-item" href="https://discord.com/channels/1075852648688930887/1372332867111358504">
 <span class="dropdown-text">Join the community</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-version" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Version</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-version">    
        <li>
    <a class="dropdown-item" href="../latest">
 <span class="dropdown-text">latest</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://prophetverse.com/0.6.0">
 <span class="dropdown-text">0.6.0</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../mmm/proxy_variables.html">Awareness: Latent and Proxy Variables</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../mmm/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome!</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../mmm/getting_familiar.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basics of MMM with Prophetverse</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../mmm/saturation_and_adstock.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Saturation and Adstock</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../mmm/fitting_and_calibration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fitting, calibrating and Unified Marketing Measurement</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../mmm/proxy_variables.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Awareness: Latent and Proxy Variables</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../mmm/mediators_and_frontdoor.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Mediators and Front-door Adjustment</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../mmm/budget_allocation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Budget Optimization</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#latent-variables" id="toc-latent-variables" class="nav-link active" data-scroll-target="#latent-variables">Latent variables</a></li>
  <li><a href="#dataset" id="toc-dataset" class="nav-link" data-scroll-target="#dataset">1. Dataset</a>
  <ul class="collapse">
  <li><a href="#loading-the-data" id="toc-loading-the-data" class="nav-link" data-scroll-target="#loading-the-data">1.1. Loading the data</a></li>
  <li><a href="#proxy-variable" id="toc-proxy-variable" class="nav-link" data-scroll-target="#proxy-variable">1.2. Proxy variable</a></li>
  </ul></li>
  <li><a href="#defining-and-fitting-the-model" id="toc-defining-and-fitting-the-model" class="nav-link" data-scroll-target="#defining-and-fitting-the-model">2. Defining and Fitting the Model</a>
  <ul class="collapse">
  <li><a href="#model-without-proxy-variable" id="toc-model-without-proxy-variable" class="nav-link" data-scroll-target="#model-without-proxy-variable">2.1. Model without Proxy Variable</a></li>
  <li><a href="#model-with-proxy-variable" id="toc-model-with-proxy-variable" class="nav-link" data-scroll-target="#model-with-proxy-variable">2.2. Model with Proxy Variable</a></li>
  </ul></li>
  <li><a href="#comparing-models" id="toc-comparing-models" class="nav-link" data-scroll-target="#comparing-models">3. Comparing models</a></li>
  <li><a href="#how-to-cite-this-package" id="toc-how-to-cite-this-package" class="nav-link" data-scroll-target="#how-to-cite-this-package">How to cite this package</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Awareness: Latent and Proxy Variables</h1>
</div>

<div>
  <div class="description">
    <strong>Using proxy variables to model latent effects, such as awareness</strong>
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>What you will learn:</p>
<ul>
<li>Understand how to model latent variables with Prophetverse</li>
<li>Learn how to use proxy variables to improve model accuracy</li>
<li>Model the last-click effect as proportional to awareness, our latent variable.</li>
</ul>
<section id="latent-variables" class="level2">
<h2 class="anchored" data-anchor-id="latent-variables">Latent variables</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>From Prophetverse v0.10.0 onwards, we have included a latent variable feature. You only need to add ‚Äúlatent/‚Äù as a prefix to the effect name, and it will not be considered as a final component in the additive decomposition. Instead, it can be used as an input to other effects or linked to proxy variables.</p>
</div>
</div>
<p>In Marketing Mix Modeling, we often encounter latent variables that are not directly observable but significantly influence sales. A common example is <strong>brand awareness</strong>. It can befined as :</p>
<blockquote class="blockquote">
<p>The ability of a potential buyer to recognize or recall that a brand is a member of a certain product category.</p>
<p>Keller, K. L. (1993). Conceptualizing, Measuring, and Managing Customer-Based Brand Equity.</p>
</blockquote>
<p>which is clearly affected by marketing activities, and in turn affects sales. Standard MMM approaches may struggle to accurately capture the impact of such latent variables, leading to biased estimates and suboptimal decision-making.</p>
<p>Since we cannot observe these variables directly, it can be hard to model them. However, we propose in Prophetverse the usage of <strong>proxy variables</strong> that are correlated with the latent variable of interest to help us infer its true causal effect. For example, we might use survey data on brand recognition or social media engagement metrics as proxies for brand awareness and use it as a soft calibration signal.</p>
<p>The idea is simple, but powerful. More formally, if <span class="math inline">\(Z(t)\)</span> is a latent variable representing brand awareness at time <span class="math inline">\(t\)</span>, and <span class="math inline">\(P(t)\)</span> is a proxy variable correlated with <span class="math inline">\(Z(t)\)</span>, we can add a new likelihood term:</p>
<p><span class="math display">\[
P(t) \sim \mathcal{N}(\beta Z(t), \sigma^2)
\]</span></p>
<p>For a <span class="math inline">\(\beta\)</span> with user-defined prior, and <span class="math inline">\(\sigma^2\)</span> representing the uncertainty in the proxy relationship. If there exists a <span class="math inline">\(\beta\)</span>, then the proxy variable provides additional information about the latent variable, helping to better identify its effect on sales.</p>
</section>
<section id="dataset" class="level2">
<h2 class="anchored" data-anchor-id="dataset">1. Dataset</h2>
<section id="loading-the-data" class="level3">
<h3 class="anchored" data-anchor-id="loading-the-data">1.1. Loading the data</h3>
<p>We use a synthetic dataset that simulates a marketing scenario with 2 types of investments:</p>
<ul>
<li>Investments with impact on brand awareness (e.g., upper-funnel channels like TV, Display, Social Media)</li>
<li>Investments with last-click impact (e.g., Search, Affiliates)</li>
</ul>
<div id="eaf6a313" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prophetverse.datasets._mmm.dataset2_branding <span class="im">import</span> get_dataset</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>y, X, true_effect, true_model <span class="op">=</span> get_dataset()</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>display(X.head())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ad_spend_awareness</th>
<th data-quarto-table-cell-role="th">last_click_spend</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2000-03-31</th>
<td>102271.901646</td>
<td>36711.937500</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2000-04-01</th>
<td>104467.149891</td>
<td>36306.410156</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2000-04-02</th>
<td>103863.702625</td>
<td>36007.777344</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2000-04-03</th>
<td>102838.194548</td>
<td>36195.750000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2000-04-04</th>
<td>103186.478348</td>
<td>36113.398438</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="5eebb1c7" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>y.plot.line(ax<span class="op">=</span>ax)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>fig.show() </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="proxy_variables_files/figure-html/cell-4-output-1.png" width="662" height="351" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>And the investment variables:</p>
<div id="5fe49a63" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>X[<span class="st">"ad_spend_awareness"</span>].plot.line(ax<span class="op">=</span>ax[<span class="dv">0</span>], title<span class="op">=</span><span class="st">"Ad Spend Awareness"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>X[<span class="st">"last_click_spend"</span>].plot.line(ax<span class="op">=</span>ax[<span class="dv">1</span>], title<span class="op">=</span><span class="st">"Last-Click Spend"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="proxy_variables_files/figure-html/cell-5-output-1.png" width="758" height="566" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Since this is a synthetic dataset, we have access to the ground truth of the effects of investments on sales. In a real-world scenario, these would be unknown. Let‚Äôs take a look at them:</p>
<div id="f99746ea" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_counterfactual(fitted_model, X, column):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    X_counterfactual <span class="op">=</span> X.copy()</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    X_counterfactual[column] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> fitted_model.predict(X<span class="op">=</span>X, fh<span class="op">=</span>X.index)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    y_pred_counterfactual <span class="op">=</span> fitted_model.predict(X<span class="op">=</span>X_counterfactual, fh<span class="op">=</span>X.index)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    delta <span class="op">=</span> y_pred <span class="op">-</span> y_pred_counterfactual</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> delta</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>ad_awareness_effect <span class="op">=</span> get_counterfactual(true_model, X, <span class="st">"ad_spend_awareness"</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>last_click_effect <span class="op">=</span> get_counterfactual(true_model, X, <span class="st">"last_click_spend"</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Top subplot</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>X[<span class="st">"ad_spend_awareness"</span>].plot.line(</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax[<span class="dv">0</span>], color<span class="op">=</span><span class="st">"orange"</span>, label<span class="op">=</span><span class="st">"Ad Spend (Observed)"</span>, legend<span class="op">=</span><span class="va">False</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>ax0r <span class="op">=</span> ax[<span class="dv">0</span>].twinx()</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>ad_awareness_effect.plot.line(ax<span class="op">=</span>ax0r, label<span class="op">=</span><span class="st">"True Effect"</span>, legend<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_title(<span class="st">"Ad Spend Awareness"</span>)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>handles0, labels0 <span class="op">=</span> ax[<span class="dv">0</span>].get_legend_handles_labels()</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>handles0r, labels0r <span class="op">=</span> ax0r.get_legend_handles_labels()</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].legend(handles0 <span class="op">+</span> handles0r, labels0 <span class="op">+</span> labels0r, loc<span class="op">=</span><span class="st">"best"</span>)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Bottom subplot</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>X[<span class="st">"last_click_spend"</span>].plot.line(</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax[<span class="dv">1</span>], color<span class="op">=</span><span class="st">"orange"</span>, label<span class="op">=</span><span class="st">"Last-Click Spend (Observed)"</span>, legend<span class="op">=</span><span class="va">False</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>ax1r <span class="op">=</span> ax[<span class="dv">1</span>].twinx()</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>last_click_effect.plot.line(ax<span class="op">=</span>ax1r, label<span class="op">=</span><span class="st">"True Effect"</span>, legend<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_title(<span class="st">"Last-Click Spend"</span>)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>handles1, labels1 <span class="op">=</span> ax[<span class="dv">1</span>].get_legend_handles_labels()</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>handles1r, labels1r <span class="op">=</span> ax1r.get_legend_handles_labels()</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].legend(handles1 <span class="op">+</span> handles1r, labels1 <span class="op">+</span> labels1r, loc<span class="op">=</span><span class="st">"best"</span>)</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="proxy_variables_files/figure-html/cell-6-output-1.png" width="758" height="566" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>A common problem in MMM is the correlation of last-click with sales, which can lead to over-attribution of sales to last-click channels if not properly accounted for. We will see later how the proxy variable can help mitigate this.</p>
</section>
<section id="proxy-variable" class="level3">
<h3 class="anchored" data-anchor-id="proxy-variable">1.2. Proxy variable</h3>
<p>In real-world scenarios, proxy variables can be obtained from various sources, such as:</p>
<ul>
<li><strong>Branded Search Volume</strong>: The volume of searches for the brand name on search engines.</li>
<li><strong>Survey Data</strong>: Periodic surveys measuring brand recognition and recall among the target audience.</li>
<li><strong>Social Media Engagement</strong>: Metrics such as likes, shares, comments, and mentions related</li>
</ul>
<p>We simulate a proxy variable correlated with the true latent awareness effect, adding some noise to it.</p>
<div id="8eaa7fe8" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.default_rng(<span class="dv">42</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>proxy_variable <span class="op">=</span> (</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    true_effect[[<span class="st">"latent/awareness"</span>]] <span class="op">/</span> true_effect[<span class="st">"latent/awareness"</span>].<span class="bu">max</span>()</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>proxy_variable <span class="op">*=</span> rng.uniform(<span class="fl">0.9</span>, <span class="fl">1.1</span>, size<span class="op">=</span><span class="bu">len</span>(proxy_variable)).reshape((<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>proxy_variable <span class="op">=</span> proxy_variable.sample(n<span class="op">=</span><span class="dv">180</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">4</span>))</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>ax.scatter(</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    proxy_variable.index.to_timestamp(),</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    proxy_variable[<span class="st">"latent/awareness"</span>].values,</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"C1"</span>,</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Proxy Variable"</span>,</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="proxy_variables_files/figure-html/cell-7-output-1.png" width="794" height="337" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="defining-and-fitting-the-model" class="level2">
<h2 class="anchored" data-anchor-id="defining-and-fitting-the-model">2. Defining and Fitting the Model</h2>
<p>We define a model that includes:</p>
<ul>
<li>Piecewise linear trend</li>
<li>Yearly and weekly seasonality</li>
<li>Latent awareness, modeled a saturation function applied to the ad spend.</li>
<li>Awareness-to-sales effect, an effect that accounts the carryover aspect of awareness impact on sales.</li>
<li>Latent baseline, modeled as the sum of trend, seasonality, and awareness-to-sales effect</li>
<li>Last-click spend effect, modeled as a Hill saturation function multiplied by the latent baseline</li>
</ul>
<p>The diagram below illustrates the model structure, including the latent variables and the proxy variable.</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">graph TD
    %% STYLES
    classDef latent fill:#dbeafe,stroke:#3b82f6,stroke-width:1px;
    classDef observed fill:#fef3c7,stroke:#f59e0b,stroke-width:1px;
    classDef proxy fill:#dcfce7,stroke:#16a34a,stroke-width:1px;
    classDef effect fill:#f3e8ff,stroke:#a855f7,stroke-width:1px;

    %% OBSERVED INPUTS
    X1["Ad Spend Awareness"]:::observed
    LastClick["Last-Click Spend"]:::observed
    Sales["Sales (y)"]:::observed

    %% LATENT STRUCTURE
    A_spend["Latent Ad Spend Awareness"]:::latent
    A_sum["Latent Awareness"]:::latent
    A_adstock["Latent Awareness Adstock"]:::latent
    Baseline["Latent Baseline (trend + seasonality + awareness)"]:::latent
    AwarenessToSales["Awareness ‚Üí Sales Effect"]:::effect

    %% PROXY
    Proxy["Proxy Variable (e.g., Branded Search / Survey)"]:::proxy

    %% RELATIONSHIPS
    X1 -- "Hill saturation function (nonlinear spend response)" --&gt; A_spend

    A_spend -- "Summed contribution" --&gt; A_sum
    

    A_sum -- "Weibull adstock (carryover decay)" --&gt; A_adstock
    A_adstock -- "Modulates baseline &amp; seasonality" --&gt; Baseline
    A_adstock -- "Drives multiplicative Awareness‚ÜíSales effect" --&gt; AwarenessToSales

    AwarenessToSales -- "Direct causal effect on sales" --&gt; Sales

    Baseline -- "Combines with last-click spend" --&gt; LastClick
    LastClick -- "Final multiplicative effect on sales" --&gt; Sales

    A_sum -- "Proportional proxy (Œ≥¬∑A + noise)" --&gt; Proxy

    %% GROUPS
    subgraph Observed
        X1
        LastClick
        Sales
        Proxy
    end

    subgraph Latent_Model
        A_spend
        A_sum
        A_adstock
        Baseline
        AwarenessToSales
    end
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>We model the last-click effect as proportional to the latent brand awareness variable, which is influenced by upper-funnel marketing activities:</p>
<p><span class="math display">\[
\text{Hill}(X_{lc}(t)) \cdot \text{Baseline}(t)
\]</span></p>
<p>where <span class="math inline">\(\text{Baseline}(t)\)</span> includes the latent brand awareness effect, trend, and seasonality components. We basically assume that the last-click effect is stronger when brand awareness is higher, which is a reasonable assumption in many marketing contexts.</p>
<section id="model-without-proxy-variable" class="level3">
<h3 class="anchored" data-anchor-id="model-without-proxy-variable">2.1. Model without Proxy Variable</h3>
<p>We first fit a baseline model without the proxy variable to see how it performs. Since last-click is highly correlated with sales, we will see how it overfits to last-click, leading to poor estimation of other components.</p>
<p>The cell below defines some effects (click to expand):</p>
<div id="47d3bdcd" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prophetverse.effects <span class="im">import</span> (</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    PiecewiseLinearTrend,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    LinearFourierSeasonality,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    ChainedEffects,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    GeometricAdstockEffect,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    WeibullAdstockEffect,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    HillEffect,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    SumEffects,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    Forward,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    Constant,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    MultiplyEffects,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prophetverse.sktime <span class="im">import</span> Prophetverse</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prophetverse.engine <span class="im">import</span> MAPInferenceEngine</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prophetverse.engine.optimizer <span class="im">import</span> LBFGSSolver</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpyro.distributions <span class="im">as</span> dist</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Defining seasonality and trend effects ---</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>trend <span class="op">=</span> PiecewiseLinearTrend(changepoint_interval<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>yearly <span class="op">=</span> (</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"yearly_seasonality"</span>,</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    LinearFourierSeasonality(</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>        freq<span class="op">=</span><span class="st">"D"</span>,</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        sp_list<span class="op">=</span>[<span class="fl">365.25</span>],</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>        fourier_terms_list<span class="op">=</span>[<span class="dv">5</span>],</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        prior_scale<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>        effect_mode<span class="op">=</span><span class="st">"multiplicative"</span>,</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    <span class="va">None</span>,</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>weekly <span class="op">=</span> (</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"weekly_seasonality"</span>,</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    LinearFourierSeasonality(</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>        freq<span class="op">=</span><span class="st">"D"</span>,</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>        sp_list<span class="op">=</span>[<span class="dv">7</span>],</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>        fourier_terms_list<span class="op">=</span>[<span class="dv">3</span>],</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>        prior_scale<span class="op">=</span><span class="fl">0.05</span>,</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>        effect_mode<span class="op">=</span><span class="st">"multiplicative"</span>,</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    <span class="va">None</span>,</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Defining marketing effects ---</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a><span class="co"># First, we set up a Hill saturation object to be reused</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>hill <span class="op">=</span> HillEffect(</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>    half_max_prior<span class="op">=</span>dist.HalfNormal(<span class="dv">1</span>),</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>    slope_prior<span class="op">=</span>dist.InverseGamma(<span class="dv">2</span>, <span class="dv">1</span>),</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>    max_effect_prior<span class="op">=</span>dist.HalfNormal(<span class="fl">0.5</span>),</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>    effect_mode<span class="op">=</span><span class="st">"additive"</span>,</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>    input_scale<span class="op">=</span><span class="fl">1e6</span>,</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a><span class="co"># The effect of ad spend on awareness is modeled with a Hill function</span></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a><span class="co"># (nonlinear spend response)</span></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>spend_awareness <span class="op">=</span> (</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>    <span class="st">"latent/awareness"</span>,</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>    hill,</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ad_spend_awareness"</span>,</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a><span class="co"># The awareness does not impact sales immediately, but rather has a carryover effect. We model this with a Weibull adstock.</span></span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>awareness_to_sales <span class="op">=</span> (</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>    <span class="st">"awareness_to_sales"</span>,</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>    ChainedEffects(</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>        [</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>            (<span class="st">"saturation"</span>, Forward(<span class="st">"latent/awareness"</span>)),</span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>            (<span class="st">"adstock"</span>, WeibullAdstockEffect(max_lag<span class="op">=</span><span class="dv">90</span>)),</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>    <span class="va">None</span>,</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a><span class="co"># The baseline is finally modeled as the sum of trend, seasonality, and latent awareness (considering adstock)</span></span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>latent_baseline <span class="op">=</span> (</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>    <span class="st">"latent/baseline"</span>,</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>    SumEffects(</span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>        effects<span class="op">=</span>[</span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>            (<span class="st">"trend"</span>, Forward(<span class="st">"trend"</span>)),</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>            (<span class="st">"yearly_seasonality"</span>, Forward(<span class="st">"yearly_seasonality"</span>)),</span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>            (<span class="st">"weekly_seasonality"</span>, Forward(<span class="st">"weekly_seasonality"</span>)),</span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>            (<span class="st">"awareness"</span>, Forward(<span class="st">"awareness_to_sales"</span>)),</span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>    <span class="va">None</span>,</span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>chained_last_click <span class="op">=</span> (</span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>    <span class="st">"last_click_spend"</span>,</span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>    MultiplyEffects(effects<span class="op">=</span>[(<span class="st">"hill"</span>, hill), </span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"baseline"</span>, Forward(<span class="st">"latent/baseline"</span>))]),</span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>    <span class="st">"last_click_spend"</span>,</span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="bf2abb83" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>baseline_model <span class="op">=</span> Prophetverse(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    trend<span class="op">=</span>trend,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    exogenous_effects<span class="op">=</span>[</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        yearly,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        weekly,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        spend_awareness,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        awareness_to_sales,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        latent_baseline,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        chained_last_click,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    inference_engine<span class="op">=</span>MAPInferenceEngine(</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        num_steps<span class="op">=</span><span class="dv">5000</span>,</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        optimizer<span class="op">=</span>LBFGSSolver(memory_size<span class="op">=</span><span class="dv">300</span>, max_linesearch_steps<span class="op">=</span><span class="dv">300</span>),</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>baseline_model.fit(y<span class="op">=</span>y, X<span class="op">=</span>X)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<style>#sk-c2f5d455-ee50-402b-8913-567c7ef3b815 {
    /* Definition of color scheme common for light and dark mode */
    --sklearn-color-text: black;
    --sklearn-color-line: gray;
    /* Definition of color scheme for objects */
    --sklearn-color-level-0: #fff5e6;
    --sklearn-color-level-1: #f6e4d2;
    --sklearn-color-level-2: #ffe0b3;
    --sklearn-color-level-3: chocolate;

    /* Specific color for light theme */
    --sklearn-color-text-on-default-background: var(--theme-code-foreground, var(--jp-content-font-color1, black));
    --sklearn-color-background: var(--theme-background, var(--jp-layout-color0, white));
    --sklearn-color-border-box: var(--theme-code-foreground, var(--jp-content-font-color1, black));
    --sklearn-color-icon: #696969;

    @media (prefers-color-scheme: dark) {
      /* Redefinition of color scheme for dark theme */
      --sklearn-color-text-on-default-background: var(--theme-code-foreground, var(--jp-content-font-color1, white));
      --sklearn-color-background: var(--theme-background, var(--jp-layout-color0, #111));
      --sklearn-color-border-box: var(--theme-code-foreground, var(--jp-content-font-color1, white));
      --sklearn-color-icon: #878787;
    }
  }

  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 {
    color: var(--sklearn-color-text);
  }

  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 pre {
    padding: 0;
  }

  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 input.sk-hidden--visually {
    border: 0;
    clip: rect(1px 1px 1px 1px);
    clip: rect(1px, 1px, 1px, 1px);
    height: 1px;
    margin: -1px;
    overflow: hidden;
    padding: 0;
    position: absolute;
    width: 1px;
  }

  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 div.sk-dashed-wrapped {
    border: 1px dashed var(--sklearn-color-line);
    margin: 0 0.4em 0.5em 0.4em;
    box-sizing: border-box;
    padding-bottom: 0.4em;
    background-color: var(--sklearn-color-background);
  }

  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 div.sk-container {
    /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
       but bootstrap.min.css set `[hidden] { display: none !important; }`
       so we also need the `!important` here to be able to override the
       default hidden behavior on the sphinx rendered scikit-learn.org.
       See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
    display: inline-block !important;
    position: relative;
  }

  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 div.sk-text-repr-fallback {
    display: none;
  }

  div.sk-parallel-item,
  div.sk-serial,
  div.sk-item {
    /* draw centered vertical line to link estimators */
    background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
    background-size: 2px 100%;
    background-repeat: no-repeat;
    background-position: center center;
  }

  /* Parallel-specific style estimator block */

  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 div.sk-parallel-item::after {
    content: "";
    width: 100%;
    border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
    flex-grow: 1;
  }

  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 div.sk-parallel {
    display: flex;
    align-items: stretch;
    justify-content: center;
    background-color: var(--sklearn-color-background);
    position: relative;
  }

  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 div.sk-parallel-item {
    display: flex;
    flex-direction: column;
  }

  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 div.sk-parallel-item:first-child::after {
    align-self: flex-end;
    width: 50%;
  }

  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 div.sk-parallel-item:last-child::after {
    align-self: flex-start;
    width: 50%;
  }

  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 div.sk-parallel-item:only-child::after {
    width: 0;
  }

  /* Serial-specific style estimator block */

  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 div.sk-serial {
    display: flex;
    flex-direction: column;
    align-items: center;
    background-color: var(--sklearn-color-background);
    padding-right: 1em;
    padding-left: 1em;
  }


  /* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
  clickable and can be expanded/collapsed.
  - Pipeline and ColumnTransformer use this feature and define the default style
  - Estimators will overwrite some part of the style using the `sk-estimator` class
  */

  /* Pipeline and ColumnTransformer style (default) */

  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 div.sk-toggleable {
    /* Default theme specific background. It is overwritten whether we have a
    specific estimator or a Pipeline/ColumnTransformer */
    background-color: var(--sklearn-color-background);
  }

  /* Toggleable label */
  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 label.sk-toggleable__label {
    cursor: pointer;
    display: block;
    width: 100%;
    margin-bottom: 0;
    padding: 0.5em;
    box-sizing: border-box;
    text-align: center;
  }

  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 label.sk-toggleable__label-arrow:before {
    /* Arrow on the left of the label */
    content: "‚ñ∏";
    float: left;
    margin-right: 0.25em;
    color: var(--sklearn-color-icon);
  }

  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 label.sk-toggleable__label-arrow:hover:before {
    color: var(--sklearn-color-text);
  }

  /* Toggleable content - dropdown */

  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 div.sk-toggleable__content {
    max-height: 0;
    max-width: 0;
    overflow: hidden;
    text-align: left;
    background-color: var(--sklearn-color-level-0);
  }

  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 div.sk-toggleable__content pre {
    margin: 0.2em;
    border-radius: 0.25em;
    color: var(--sklearn-color-text);
    background-color: var(--sklearn-color-level-0);
  }

  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 input.sk-toggleable__control:checked~div.sk-toggleable__content {
    /* Expand drop-down */
    max-height: 200px;
    max-width: 100%;
    overflow: auto;
  }

  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
    content: "‚ñæ";
  }

  /* Pipeline/ColumnTransformer-specific style */

  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
    color: var(--sklearn-color-text);
    background-color: var(--sklearn-color-level-2);
  }

  /* Estimator-specific style */

  /* Colorize estimator box */
  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
    /* unfitted */
    background-color: var(--sklearn-color-level-2);
  }

  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 div.sk-label label.sk-toggleable__label,
  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 div.sk-label label {
    /* The background is the default theme color */
    color: var(--sklearn-color-text-on-default-background);
  }

  /* On hover, darken the color of the background */
  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 div.sk-label:hover label.sk-toggleable__label {
    color: var(--sklearn-color-text);
    background-color: var(--sklearn-color-level-2);
  }

  /* Estimator label */

  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 div.sk-label label {
    font-family: monospace;
    font-weight: bold;
    display: inline-block;
    line-height: 1.2em;
  }

  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 div.sk-label-container {
    text-align: center;
  }

  /* Estimator-specific */
  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 div.sk-estimator {
    font-family: monospace;
    border: 1px dotted var(--sklearn-color-border-box);
    border-radius: 0.25em;
    box-sizing: border-box;
    margin-bottom: 0.5em;
    background-color: var(--sklearn-color-level-0);
  }

  /* on hover */
  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 div.sk-estimator:hover {
    background-color: var(--sklearn-color-level-2);
  }

  /* Specification for estimator info */

  .sk-estimator-doc-link,
  a:link.sk-estimator-doc-link,
  a:visited.sk-estimator-doc-link {
    float: right;
    font-size: smaller;
    line-height: 1em;
    font-family: monospace;
    background-color: var(--sklearn-color-background);
    border-radius: 1em;
    height: 1em;
    width: 1em;
    text-decoration: none !important;
    margin-left: 1ex;
    border: var(--sklearn-color-level-1) 1pt solid;
    color: var(--sklearn-color-level-1);
  }

  /* On hover */
  div.sk-estimator:hover .sk-estimator-doc-link:hover,
  .sk-estimator-doc-link:hover,
  div.sk-label-container:hover .sk-estimator-doc-link:hover,
  .sk-estimator-doc-link:hover {
    background-color: var(--sklearn-color-level-3);
    color: var(--sklearn-color-background);
    text-decoration: none;
  }

  /* Span, style for the box shown on hovering the info icon */
  .sk-estimator-doc-link span {
    display: none;
    z-index: 9999;
    position: relative;
    font-weight: normal;
    right: .2ex;
    padding: .5ex;
    margin: .5ex;
    width: min-content;
    min-width: 20ex;
    max-width: 50ex;
    color: var(--sklearn-color-text);
    box-shadow: 2pt 2pt 4pt #999;
    background: var(--sklearn-color-level-0);
    border: .5pt solid var(--sklearn-color-level-3);
  }

  .sk-estimator-doc-link:hover span {
    display: block;
  }

  /* "?"-specific style due to the `<a>` HTML tag */

  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 a.estimator_doc_link {
    float: right;
    font-size: 1rem;
    line-height: 1em;
    font-family: monospace;
    background-color: var(--sklearn-color-background);
    border-radius: 1rem;
    height: 1rem;
    width: 1rem;
    text-decoration: none;
    color: var(--sklearn-color-level-1);
    border: var(--sklearn-color-level-1) 1pt solid;
  }

  /* On hover */
  #sk-c2f5d455-ee50-402b-8913-567c7ef3b815 a.estimator_doc_link:hover {
    background-color: var(--sklearn-color-level-3);
    color: var(--sklearn-color-background);
    text-decoration: none;
  }
</style><div id="sk-c2f5d455-ee50-402b-8913-567c7ef3b815" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>Prophetverse(exogenous_effects=[('yearly_seasonality',
                                 LinearFourierSeasonality(effect_mode='multiplicative',
                                                          fourier_terms_list=[5],
                                                          freq='D',
                                                          prior_scale=0.1,
                                                          sp_list=[365.25]),
                                 None),
                                ('weekly_seasonality',
                                 LinearFourierSeasonality(effect_mode='multiplicative',
                                                          fourier_terms_list=[3],
                                                          freq='D',
                                                          prior_scale=0.05,
                                                          sp_list=[7]),
                                 None),
                                ('latent/awareness',
                                 HillEf...
                                                                      slope_prior=&lt;numpyro.distributions.continuous.InverseGamma object at 0x7f5598439dd0 with batch shape () and event shape ()&gt;)),
                                                          ('baseline',
                                                           Forward(effect_name='latent/baseline'))]),
                                 'last_click_spend')],
             inference_engine=MAPInferenceEngine(num_steps=5000,
                                                 optimizer=LBFGSSolver(max_linesearch_steps=300,
                                                                       memory_size=300)),
             trend=PiecewiseLinearTrend(changepoint_interval=300))</pre><b>Please rerun this cell to show the HTML repr or trust the notebook.</b></div><div class="sk-container" hidden=""><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('4da28395-4c32-428a-8413-bf8b48c4815a')" type="checkbox"><label for="UUID('4da28395-4c32-428a-8413-bf8b48c4815a')" class="sk-toggleable__label sk-toggleable__label-arrow">Prophetverse</label><div class="sk-toggleable__content"><pre>Prophetverse(exogenous_effects=[('yearly_seasonality',
                                 LinearFourierSeasonality(effect_mode='multiplicative',
                                                          fourier_terms_list=[5],
                                                          freq='D',
                                                          prior_scale=0.1,
                                                          sp_list=[365.25]),
                                 None),
                                ('weekly_seasonality',
                                 LinearFourierSeasonality(effect_mode='multiplicative',
                                                          fourier_terms_list=[3],
                                                          freq='D',
                                                          prior_scale=0.05,
                                                          sp_list=[7]),
                                 None),
                                ('latent/awareness',
                                 HillEf...
                                                                      slope_prior=&lt;numpyro.distributions.continuous.InverseGamma object at 0x7f5598439dd0 with batch shape () and event shape ()&gt;)),
                                                          ('baseline',
                                                           Forward(effect_name='latent/baseline'))]),
                                 'last_click_spend')],
             inference_engine=MAPInferenceEngine(num_steps=5000,
                                                 optimizer=LBFGSSolver(max_linesearch_steps=300,
                                                                       memory_size=300)),
             trend=PiecewiseLinearTrend(changepoint_interval=300))</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><label>effects</label></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('938b1b74-b178-4c07-b7e7-9838ba9303a2')" type="checkbox"><label for="UUID('938b1b74-b178-4c07-b7e7-9838ba9303a2')" class="sk-toggleable__label sk-toggleable__label-arrow">PiecewiseLinearTrend</label><div class="sk-toggleable__content"><pre>PiecewiseLinearTrend(changepoint_interval=300)</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('47de3d9c-8f6c-4d78-bead-74e82db4ea49')" type="checkbox"><label for="UUID('47de3d9c-8f6c-4d78-bead-74e82db4ea49')" class="sk-toggleable__label sk-toggleable__label-arrow">LinearFourierSeasonality</label><div class="sk-toggleable__content"><pre>LinearFourierSeasonality(effect_mode='multiplicative', fourier_terms_list=[5],
                         freq='D', prior_scale=0.1, sp_list=[365.25])</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('9c669d7d-a94d-4a8e-a62b-94d7f04933c1')" type="checkbox"><label for="UUID('9c669d7d-a94d-4a8e-a62b-94d7f04933c1')" class="sk-toggleable__label sk-toggleable__label-arrow">LinearFourierSeasonality</label><div class="sk-toggleable__content"><pre>LinearFourierSeasonality(effect_mode='multiplicative', fourier_terms_list=[3],
                         freq='D', prior_scale=0.05, sp_list=[7])</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('c1af3359-3546-4add-9442-8d45a4ea74f9')" type="checkbox"><label for="UUID('c1af3359-3546-4add-9442-8d45a4ea74f9')" class="sk-toggleable__label sk-toggleable__label-arrow">HillEffect</label><div class="sk-toggleable__content"><pre>HillEffect(effect_mode='additive',
           half_max_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f5598418cd0 with batch shape () and event shape ()&gt;,
           input_scale=1000000.0,
           max_effect_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f5604f4cc90 with batch shape () and event shape ()&gt;,
           slope_prior=&lt;numpyro.distributions.continuous.InverseGamma object at 0x7f5598439dd0 with batch shape () and event shape ()&gt;)</pre></div></div></div><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('c8dc994f-9bbb-4182-b670-350f07eeff4c')" type="checkbox"><label for="UUID('c8dc994f-9bbb-4182-b670-350f07eeff4c')" class="sk-toggleable__label sk-toggleable__label-arrow">awareness_to_sales</label><div class="sk-toggleable__content"><pre>ChainedEffects(steps=[('saturation', Forward(effect_name='latent/awareness')),
                      ('adstock', WeibullAdstockEffect(max_lag=90))])</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('0cc36190-731f-45f6-bdf0-ade8542e240d')" type="checkbox"><label for="UUID('0cc36190-731f-45f6-bdf0-ade8542e240d')" class="sk-toggleable__label sk-toggleable__label-arrow">Forward</label><div class="sk-toggleable__content"><pre>Forward(effect_name='latent/awareness')</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('8852a930-0afe-4046-afa5-f145fb2c0e22')" type="checkbox"><label for="UUID('8852a930-0afe-4046-afa5-f145fb2c0e22')" class="sk-toggleable__label sk-toggleable__label-arrow">WeibullAdstockEffect</label><div class="sk-toggleable__content"><pre>WeibullAdstockEffect(max_lag=90)</pre></div></div></div></div></div><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('eb7c0072-483b-4bd4-aff3-1699de644ca0')" type="checkbox"><label for="UUID('eb7c0072-483b-4bd4-aff3-1699de644ca0')" class="sk-toggleable__label sk-toggleable__label-arrow">latent/baseline</label><div class="sk-toggleable__content"><pre>SumEffects(effects=[('trend', Forward(effect_name='trend')),
                    ('yearly_seasonality',
                     Forward(effect_name='yearly_seasonality')),
                    ('weekly_seasonality',
                     Forward(effect_name='weekly_seasonality')),
                    ('awareness', Forward(effect_name='awareness_to_sales'))])</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('54fb5870-dad9-4665-b3ac-bb5e33a9ca4f')" type="checkbox"><label for="UUID('54fb5870-dad9-4665-b3ac-bb5e33a9ca4f')" class="sk-toggleable__label sk-toggleable__label-arrow">Forward</label><div class="sk-toggleable__content"><pre>Forward(effect_name='trend')</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('b3d59b66-4de4-4cc3-9d02-cef3d00afad8')" type="checkbox"><label for="UUID('b3d59b66-4de4-4cc3-9d02-cef3d00afad8')" class="sk-toggleable__label sk-toggleable__label-arrow">Forward</label><div class="sk-toggleable__content"><pre>Forward(effect_name='yearly_seasonality')</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('a80431f4-293c-4cef-bf80-5c1972e04723')" type="checkbox"><label for="UUID('a80431f4-293c-4cef-bf80-5c1972e04723')" class="sk-toggleable__label sk-toggleable__label-arrow">Forward</label><div class="sk-toggleable__content"><pre>Forward(effect_name='weekly_seasonality')</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('2a74ad83-dae3-48d5-9bd4-5cabe8219d6b')" type="checkbox"><label for="UUID('2a74ad83-dae3-48d5-9bd4-5cabe8219d6b')" class="sk-toggleable__label sk-toggleable__label-arrow">Forward</label><div class="sk-toggleable__content"><pre>Forward(effect_name='awareness_to_sales')</pre></div></div></div></div></div><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('9dca8e5e-e380-43ad-8b35-baef8de4457e')" type="checkbox"><label for="UUID('9dca8e5e-e380-43ad-8b35-baef8de4457e')" class="sk-toggleable__label sk-toggleable__label-arrow">last_click_spend</label><div class="sk-toggleable__content"><pre>MultiplyEffects(effects=[('hill',
                          HillEffect(effect_mode='additive',
                                     half_max_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f5598418cd0 with batch shape () and event shape ()&gt;,
                                     input_scale=1000000.0,
                                     max_effect_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f5604f4cc90 with batch shape () and event shape ()&gt;,
                                     slope_prior=&lt;numpyro.distributions.continuous.InverseGamma object at 0x7f5598439dd0 with batch shape () and event shape ()&gt;)),
                         ('baseline', Forward(effect_name='latent/baseline'))])</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('d3c2a058-2d25-4924-a091-d08f155c954d')" type="checkbox"><label for="UUID('d3c2a058-2d25-4924-a091-d08f155c954d')" class="sk-toggleable__label sk-toggleable__label-arrow">HillEffect</label><div class="sk-toggleable__content"><pre>HillEffect(effect_mode='additive',
           half_max_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f5598418cd0 with batch shape () and event shape ()&gt;,
           input_scale=1000000.0,
           max_effect_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f5604f4cc90 with batch shape () and event shape ()&gt;,
           slope_prior=&lt;numpyro.distributions.continuous.InverseGamma object at 0x7f5598439dd0 with batch shape () and event shape ()&gt;)</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('cb2a6f1d-2ca5-447a-9b69-de66eb168fce')" type="checkbox"><label for="UUID('cb2a6f1d-2ca5-447a-9b69-de66eb168fce')" class="sk-toggleable__label sk-toggleable__label-arrow">Forward</label><div class="sk-toggleable__content"><pre>Forward(effect_name='latent/baseline')</pre></div></div></div></div></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><label>inference_engine</label></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('0f0deee4-47e6-458f-8096-bfa19ab22e1c')" type="checkbox"><label for="UUID('0f0deee4-47e6-458f-8096-bfa19ab22e1c')" class="sk-toggleable__label sk-toggleable__label-arrow">MAPInferenceEngine</label><div class="sk-toggleable__content"><pre>MAPInferenceEngine(num_steps=5000,
                   optimizer=LBFGSSolver(max_linesearch_steps=300,
                                         memory_size=300))</pre></div></div></div></div></div></div></div></div></div></div>
</div>
</div>
<p>Let‚Äôs visualize the predictions of this baseline model:</p>
<div id="cbe3202e" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> baseline_model.predict(X<span class="op">=</span>X, fh<span class="op">=</span>X.index)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>y.plot(label<span class="op">=</span><span class="st">"Observed"</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>y_pred.plot(label<span class="op">=</span><span class="st">"Predicted"</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"In-Sample Forecast: Observed vs Predicted"</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="proxy_variables_files/figure-html/cell-10-output-1.png" width="662" height="357" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Forecast quality alone does not tell the full story of how well the model is capturing the underlying dynamics.</p>
<p><em>Component-Level Diagnostics</em></p>
<p>With <code>predict_components</code>, we can obtain the model‚Äôs components.</p>
<div id="2898f9a8" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>y_pred_components_baseline <span class="op">=</span> baseline_model.predict_components(X<span class="op">=</span>X, fh<span class="op">=</span>X.index)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Since we have access to the ground truth of the components in this synthetic example, we can compare them to see how well the model is capturing the true effects.</p>
<div id="31f44d3c" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">5</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">12</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, name <span class="kw">in</span> <span class="bu">enumerate</span>(</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"trend"</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"yearly_seasonality"</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"latent/awareness"</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"awareness_to_sales"</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"last_click_spend"</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    true_effect[name].plot(ax<span class="op">=</span>axs[i], label<span class="op">=</span><span class="st">"True"</span>, color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    y_pred_components_baseline[name].plot(ax<span class="op">=</span>axs[i], label<span class="op">=</span><span class="st">"Estimated"</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    axs[i].set_title(name)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    axs[i].legend()</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="proxy_variables_files/figure-html/cell-12-output-1.png" width="758" height="1142" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Since the last-click spend is highly correlated with sales, the model tends to over-attribute sales to the last-click effect, leading to poor estimation of other components, especially the latent awareness effect.</p>
</section>
<section id="model-with-proxy-variable" class="level3">
<h3 class="anchored" data-anchor-id="model-with-proxy-variable">2.2. Model with Proxy Variable</h3>
<p>We use <code>LinearProxyLikelihood</code> to add the proxy variable to the model. This effect links the latent awareness variable to the observed proxy variable, helping to better identify the latent effect.</p>
<p>Since we know that the correlation is positive, we use a HalfNormal prior for the coefficient.</p>
<div id="893e9fb5" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> prophetverse.effects.proxy_likelihood <span class="im">import</span> LinearProxyLikelihood</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>proxy_effect <span class="op">=</span> (</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"awareness_proxy"</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    LinearProxyLikelihood(</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        effect_name<span class="op">=</span><span class="st">"latent/awareness"</span>,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        reference_df<span class="op">=</span>proxy_variable,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>        coefficient_prior<span class="op">=</span>dist.HalfNormal(<span class="fl">0.2</span>),</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        likelihood_scale<span class="op">=</span><span class="fl">0.05</span>,</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">None</span>,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Prophetverse(</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    trend<span class="op">=</span>PiecewiseLinearTrend(changepoint_interval<span class="op">=</span><span class="dv">300</span>),</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    exogenous_effects<span class="op">=</span>[</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>        yearly,</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>        weekly,</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        spend_awareness,</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        awareness_to_sales,</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        latent_baseline,</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>        chained_last_click,</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>        proxy_effect,</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    inference_engine<span class="op">=</span>MAPInferenceEngine(</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>        num_steps<span class="op">=</span><span class="dv">5000</span>,</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>        optimizer<span class="op">=</span>LBFGSSolver(memory_size<span class="op">=</span><span class="dv">300</span>, max_linesearch_steps<span class="op">=</span><span class="dv">300</span>),</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>model.fit(y<span class="op">=</span>y, X<span class="op">=</span>X)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<style>#sk-c35df279-a150-4f53-b3d3-cabcecf08975 {
    /* Definition of color scheme common for light and dark mode */
    --sklearn-color-text: black;
    --sklearn-color-line: gray;
    /* Definition of color scheme for objects */
    --sklearn-color-level-0: #fff5e6;
    --sklearn-color-level-1: #f6e4d2;
    --sklearn-color-level-2: #ffe0b3;
    --sklearn-color-level-3: chocolate;

    /* Specific color for light theme */
    --sklearn-color-text-on-default-background: var(--theme-code-foreground, var(--jp-content-font-color1, black));
    --sklearn-color-background: var(--theme-background, var(--jp-layout-color0, white));
    --sklearn-color-border-box: var(--theme-code-foreground, var(--jp-content-font-color1, black));
    --sklearn-color-icon: #696969;

    @media (prefers-color-scheme: dark) {
      /* Redefinition of color scheme for dark theme */
      --sklearn-color-text-on-default-background: var(--theme-code-foreground, var(--jp-content-font-color1, white));
      --sklearn-color-background: var(--theme-background, var(--jp-layout-color0, #111));
      --sklearn-color-border-box: var(--theme-code-foreground, var(--jp-content-font-color1, white));
      --sklearn-color-icon: #878787;
    }
  }

  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 {
    color: var(--sklearn-color-text);
  }

  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 pre {
    padding: 0;
  }

  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 input.sk-hidden--visually {
    border: 0;
    clip: rect(1px 1px 1px 1px);
    clip: rect(1px, 1px, 1px, 1px);
    height: 1px;
    margin: -1px;
    overflow: hidden;
    padding: 0;
    position: absolute;
    width: 1px;
  }

  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 div.sk-dashed-wrapped {
    border: 1px dashed var(--sklearn-color-line);
    margin: 0 0.4em 0.5em 0.4em;
    box-sizing: border-box;
    padding-bottom: 0.4em;
    background-color: var(--sklearn-color-background);
  }

  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 div.sk-container {
    /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
       but bootstrap.min.css set `[hidden] { display: none !important; }`
       so we also need the `!important` here to be able to override the
       default hidden behavior on the sphinx rendered scikit-learn.org.
       See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
    display: inline-block !important;
    position: relative;
  }

  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 div.sk-text-repr-fallback {
    display: none;
  }

  div.sk-parallel-item,
  div.sk-serial,
  div.sk-item {
    /* draw centered vertical line to link estimators */
    background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
    background-size: 2px 100%;
    background-repeat: no-repeat;
    background-position: center center;
  }

  /* Parallel-specific style estimator block */

  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 div.sk-parallel-item::after {
    content: "";
    width: 100%;
    border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
    flex-grow: 1;
  }

  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 div.sk-parallel {
    display: flex;
    align-items: stretch;
    justify-content: center;
    background-color: var(--sklearn-color-background);
    position: relative;
  }

  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 div.sk-parallel-item {
    display: flex;
    flex-direction: column;
  }

  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 div.sk-parallel-item:first-child::after {
    align-self: flex-end;
    width: 50%;
  }

  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 div.sk-parallel-item:last-child::after {
    align-self: flex-start;
    width: 50%;
  }

  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 div.sk-parallel-item:only-child::after {
    width: 0;
  }

  /* Serial-specific style estimator block */

  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 div.sk-serial {
    display: flex;
    flex-direction: column;
    align-items: center;
    background-color: var(--sklearn-color-background);
    padding-right: 1em;
    padding-left: 1em;
  }


  /* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
  clickable and can be expanded/collapsed.
  - Pipeline and ColumnTransformer use this feature and define the default style
  - Estimators will overwrite some part of the style using the `sk-estimator` class
  */

  /* Pipeline and ColumnTransformer style (default) */

  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 div.sk-toggleable {
    /* Default theme specific background. It is overwritten whether we have a
    specific estimator or a Pipeline/ColumnTransformer */
    background-color: var(--sklearn-color-background);
  }

  /* Toggleable label */
  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 label.sk-toggleable__label {
    cursor: pointer;
    display: block;
    width: 100%;
    margin-bottom: 0;
    padding: 0.5em;
    box-sizing: border-box;
    text-align: center;
  }

  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 label.sk-toggleable__label-arrow:before {
    /* Arrow on the left of the label */
    content: "‚ñ∏";
    float: left;
    margin-right: 0.25em;
    color: var(--sklearn-color-icon);
  }

  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 label.sk-toggleable__label-arrow:hover:before {
    color: var(--sklearn-color-text);
  }

  /* Toggleable content - dropdown */

  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 div.sk-toggleable__content {
    max-height: 0;
    max-width: 0;
    overflow: hidden;
    text-align: left;
    background-color: var(--sklearn-color-level-0);
  }

  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 div.sk-toggleable__content pre {
    margin: 0.2em;
    border-radius: 0.25em;
    color: var(--sklearn-color-text);
    background-color: var(--sklearn-color-level-0);
  }

  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 input.sk-toggleable__control:checked~div.sk-toggleable__content {
    /* Expand drop-down */
    max-height: 200px;
    max-width: 100%;
    overflow: auto;
  }

  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
    content: "‚ñæ";
  }

  /* Pipeline/ColumnTransformer-specific style */

  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
    color: var(--sklearn-color-text);
    background-color: var(--sklearn-color-level-2);
  }

  /* Estimator-specific style */

  /* Colorize estimator box */
  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
    /* unfitted */
    background-color: var(--sklearn-color-level-2);
  }

  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 div.sk-label label.sk-toggleable__label,
  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 div.sk-label label {
    /* The background is the default theme color */
    color: var(--sklearn-color-text-on-default-background);
  }

  /* On hover, darken the color of the background */
  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 div.sk-label:hover label.sk-toggleable__label {
    color: var(--sklearn-color-text);
    background-color: var(--sklearn-color-level-2);
  }

  /* Estimator label */

  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 div.sk-label label {
    font-family: monospace;
    font-weight: bold;
    display: inline-block;
    line-height: 1.2em;
  }

  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 div.sk-label-container {
    text-align: center;
  }

  /* Estimator-specific */
  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 div.sk-estimator {
    font-family: monospace;
    border: 1px dotted var(--sklearn-color-border-box);
    border-radius: 0.25em;
    box-sizing: border-box;
    margin-bottom: 0.5em;
    background-color: var(--sklearn-color-level-0);
  }

  /* on hover */
  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 div.sk-estimator:hover {
    background-color: var(--sklearn-color-level-2);
  }

  /* Specification for estimator info */

  .sk-estimator-doc-link,
  a:link.sk-estimator-doc-link,
  a:visited.sk-estimator-doc-link {
    float: right;
    font-size: smaller;
    line-height: 1em;
    font-family: monospace;
    background-color: var(--sklearn-color-background);
    border-radius: 1em;
    height: 1em;
    width: 1em;
    text-decoration: none !important;
    margin-left: 1ex;
    border: var(--sklearn-color-level-1) 1pt solid;
    color: var(--sklearn-color-level-1);
  }

  /* On hover */
  div.sk-estimator:hover .sk-estimator-doc-link:hover,
  .sk-estimator-doc-link:hover,
  div.sk-label-container:hover .sk-estimator-doc-link:hover,
  .sk-estimator-doc-link:hover {
    background-color: var(--sklearn-color-level-3);
    color: var(--sklearn-color-background);
    text-decoration: none;
  }

  /* Span, style for the box shown on hovering the info icon */
  .sk-estimator-doc-link span {
    display: none;
    z-index: 9999;
    position: relative;
    font-weight: normal;
    right: .2ex;
    padding: .5ex;
    margin: .5ex;
    width: min-content;
    min-width: 20ex;
    max-width: 50ex;
    color: var(--sklearn-color-text);
    box-shadow: 2pt 2pt 4pt #999;
    background: var(--sklearn-color-level-0);
    border: .5pt solid var(--sklearn-color-level-3);
  }

  .sk-estimator-doc-link:hover span {
    display: block;
  }

  /* "?"-specific style due to the `<a>` HTML tag */

  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 a.estimator_doc_link {
    float: right;
    font-size: 1rem;
    line-height: 1em;
    font-family: monospace;
    background-color: var(--sklearn-color-background);
    border-radius: 1rem;
    height: 1rem;
    width: 1rem;
    text-decoration: none;
    color: var(--sklearn-color-level-1);
    border: var(--sklearn-color-level-1) 1pt solid;
  }

  /* On hover */
  #sk-c35df279-a150-4f53-b3d3-cabcecf08975 a.estimator_doc_link:hover {
    background-color: var(--sklearn-color-level-3);
    color: var(--sklearn-color-background);
    text-decoration: none;
  }
</style><div id="sk-c35df279-a150-4f53-b3d3-cabcecf08975" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>Prophetverse(exogenous_effects=[('yearly_seasonality',
                                 LinearFourierSeasonality(effect_mode='multiplicative',
                                                          fourier_terms_list=[5],
                                                          freq='D',
                                                          prior_scale=0.1,
                                                          sp_list=[365.25]),
                                 None),
                                ('weekly_seasonality',
                                 LinearFourierSeasonality(effect_mode='multiplicative',
                                                          fourier_terms_list=[3],
                                                          freq='D',
                                                          prior_scale=0.05,
                                                          sp_list=[7]),
                                 None),
                                ('latent/awareness',
                                 HillEf...
2004-05-15          0.842808
2002-11-06          0.076063
2002-12-31          0.079602
2002-03-06          0.744027
...                      ...
2004-10-21          0.351357
2004-05-23          0.813127
2000-05-29          0.914647
2003-06-26          0.040826
2001-03-17          0.791952

[180 rows x 1 columns]),
                                 None)],
             inference_engine=MAPInferenceEngine(num_steps=5000,
                                                 optimizer=LBFGSSolver(max_linesearch_steps=300,
                                                                       memory_size=300)),
             trend=PiecewiseLinearTrend(changepoint_interval=300))</pre><b>Please rerun this cell to show the HTML repr or trust the notebook.</b></div><div class="sk-container" hidden=""><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('869cc7d3-832a-4a3e-9344-1d1db13be46f')" type="checkbox"><label for="UUID('869cc7d3-832a-4a3e-9344-1d1db13be46f')" class="sk-toggleable__label sk-toggleable__label-arrow">Prophetverse</label><div class="sk-toggleable__content"><pre>Prophetverse(exogenous_effects=[('yearly_seasonality',
                                 LinearFourierSeasonality(effect_mode='multiplicative',
                                                          fourier_terms_list=[5],
                                                          freq='D',
                                                          prior_scale=0.1,
                                                          sp_list=[365.25]),
                                 None),
                                ('weekly_seasonality',
                                 LinearFourierSeasonality(effect_mode='multiplicative',
                                                          fourier_terms_list=[3],
                                                          freq='D',
                                                          prior_scale=0.05,
                                                          sp_list=[7]),
                                 None),
                                ('latent/awareness',
                                 HillEf...
2004-05-15          0.842808
2002-11-06          0.076063
2002-12-31          0.079602
2002-03-06          0.744027
...                      ...
2004-10-21          0.351357
2004-05-23          0.813127
2000-05-29          0.914647
2003-06-26          0.040826
2001-03-17          0.791952

[180 rows x 1 columns]),
                                 None)],
             inference_engine=MAPInferenceEngine(num_steps=5000,
                                                 optimizer=LBFGSSolver(max_linesearch_steps=300,
                                                                       memory_size=300)),
             trend=PiecewiseLinearTrend(changepoint_interval=300))</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><label>effects</label></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('971fcc97-cee6-4075-b6bf-e9ba7b70df3a')" type="checkbox"><label for="UUID('971fcc97-cee6-4075-b6bf-e9ba7b70df3a')" class="sk-toggleable__label sk-toggleable__label-arrow">PiecewiseLinearTrend</label><div class="sk-toggleable__content"><pre>PiecewiseLinearTrend(changepoint_interval=300)</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('957bf019-438b-4c88-bb91-e2a4ab49ca72')" type="checkbox"><label for="UUID('957bf019-438b-4c88-bb91-e2a4ab49ca72')" class="sk-toggleable__label sk-toggleable__label-arrow">LinearFourierSeasonality</label><div class="sk-toggleable__content"><pre>LinearFourierSeasonality(effect_mode='multiplicative', fourier_terms_list=[5],
                         freq='D', prior_scale=0.1, sp_list=[365.25])</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('98515f8b-2719-4e7a-9e8e-e8e3eee8ea2d')" type="checkbox"><label for="UUID('98515f8b-2719-4e7a-9e8e-e8e3eee8ea2d')" class="sk-toggleable__label sk-toggleable__label-arrow">LinearFourierSeasonality</label><div class="sk-toggleable__content"><pre>LinearFourierSeasonality(effect_mode='multiplicative', fourier_terms_list=[3],
                         freq='D', prior_scale=0.05, sp_list=[7])</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('cfa92f5e-ebb1-4574-b0f7-dffe5952f13a')" type="checkbox"><label for="UUID('cfa92f5e-ebb1-4574-b0f7-dffe5952f13a')" class="sk-toggleable__label sk-toggleable__label-arrow">HillEffect</label><div class="sk-toggleable__content"><pre>HillEffect(effect_mode='additive',
           half_max_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f5598418cd0 with batch shape () and event shape ()&gt;,
           input_scale=1000000.0,
           max_effect_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f5604f4cc90 with batch shape () and event shape ()&gt;,
           slope_prior=&lt;numpyro.distributions.continuous.InverseGamma object at 0x7f5598439dd0 with batch shape () and event shape ()&gt;)</pre></div></div></div><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('2b05f019-84e1-478d-ac4d-b212102313ec')" type="checkbox"><label for="UUID('2b05f019-84e1-478d-ac4d-b212102313ec')" class="sk-toggleable__label sk-toggleable__label-arrow">awareness_to_sales</label><div class="sk-toggleable__content"><pre>ChainedEffects(steps=[('saturation', Forward(effect_name='latent/awareness')),
                      ('adstock', WeibullAdstockEffect(max_lag=90))])</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('aee3e741-98dc-4f6c-b744-f11ae19b712f')" type="checkbox"><label for="UUID('aee3e741-98dc-4f6c-b744-f11ae19b712f')" class="sk-toggleable__label sk-toggleable__label-arrow">Forward</label><div class="sk-toggleable__content"><pre>Forward(effect_name='latent/awareness')</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('00273b8d-ae59-4d5d-8e6a-91551b6a68ec')" type="checkbox"><label for="UUID('00273b8d-ae59-4d5d-8e6a-91551b6a68ec')" class="sk-toggleable__label sk-toggleable__label-arrow">WeibullAdstockEffect</label><div class="sk-toggleable__content"><pre>WeibullAdstockEffect(max_lag=90)</pre></div></div></div></div></div><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('c25a788b-30b0-464c-aae9-6807b610f0ad')" type="checkbox"><label for="UUID('c25a788b-30b0-464c-aae9-6807b610f0ad')" class="sk-toggleable__label sk-toggleable__label-arrow">latent/baseline</label><div class="sk-toggleable__content"><pre>SumEffects(effects=[('trend', Forward(effect_name='trend')),
                    ('yearly_seasonality',
                     Forward(effect_name='yearly_seasonality')),
                    ('weekly_seasonality',
                     Forward(effect_name='weekly_seasonality')),
                    ('awareness', Forward(effect_name='awareness_to_sales'))])</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('47235c61-bb8e-49af-9fb4-b1f6dfe9ae91')" type="checkbox"><label for="UUID('47235c61-bb8e-49af-9fb4-b1f6dfe9ae91')" class="sk-toggleable__label sk-toggleable__label-arrow">Forward</label><div class="sk-toggleable__content"><pre>Forward(effect_name='trend')</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('a0c3ba21-128a-44bf-80e2-a2bb208a679b')" type="checkbox"><label for="UUID('a0c3ba21-128a-44bf-80e2-a2bb208a679b')" class="sk-toggleable__label sk-toggleable__label-arrow">Forward</label><div class="sk-toggleable__content"><pre>Forward(effect_name='yearly_seasonality')</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('849d4a8e-4019-47c6-9442-eab0b738e682')" type="checkbox"><label for="UUID('849d4a8e-4019-47c6-9442-eab0b738e682')" class="sk-toggleable__label sk-toggleable__label-arrow">Forward</label><div class="sk-toggleable__content"><pre>Forward(effect_name='weekly_seasonality')</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('fb8c74e6-10b3-4a91-9eb5-47540801199a')" type="checkbox"><label for="UUID('fb8c74e6-10b3-4a91-9eb5-47540801199a')" class="sk-toggleable__label sk-toggleable__label-arrow">Forward</label><div class="sk-toggleable__content"><pre>Forward(effect_name='awareness_to_sales')</pre></div></div></div></div></div><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('079db2bc-71d3-45a2-beea-f1abbd7a18de')" type="checkbox"><label for="UUID('079db2bc-71d3-45a2-beea-f1abbd7a18de')" class="sk-toggleable__label sk-toggleable__label-arrow">last_click_spend</label><div class="sk-toggleable__content"><pre>MultiplyEffects(effects=[('hill',
                          HillEffect(effect_mode='additive',
                                     half_max_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f5598418cd0 with batch shape () and event shape ()&gt;,
                                     input_scale=1000000.0,
                                     max_effect_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f5604f4cc90 with batch shape () and event shape ()&gt;,
                                     slope_prior=&lt;numpyro.distributions.continuous.InverseGamma object at 0x7f5598439dd0 with batch shape () and event shape ()&gt;)),
                         ('baseline', Forward(effect_name='latent/baseline'))])</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('0379b4d7-3196-4aba-b0aa-2797752478f3')" type="checkbox"><label for="UUID('0379b4d7-3196-4aba-b0aa-2797752478f3')" class="sk-toggleable__label sk-toggleable__label-arrow">HillEffect</label><div class="sk-toggleable__content"><pre>HillEffect(effect_mode='additive',
           half_max_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f5598418cd0 with batch shape () and event shape ()&gt;,
           input_scale=1000000.0,
           max_effect_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f5604f4cc90 with batch shape () and event shape ()&gt;,
           slope_prior=&lt;numpyro.distributions.continuous.InverseGamma object at 0x7f5598439dd0 with batch shape () and event shape ()&gt;)</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('d2a291b0-dfe4-4208-9c19-fe369f8b78b0')" type="checkbox"><label for="UUID('d2a291b0-dfe4-4208-9c19-fe369f8b78b0')" class="sk-toggleable__label sk-toggleable__label-arrow">Forward</label><div class="sk-toggleable__content"><pre>Forward(effect_name='latent/baseline')</pre></div></div></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('fc6f8822-61a6-4362-bfae-4e522bf8a345')" type="checkbox"><label for="UUID('fc6f8822-61a6-4362-bfae-4e522bf8a345')" class="sk-toggleable__label sk-toggleable__label-arrow">LinearProxyLikelihood</label><div class="sk-toggleable__content"><pre>LinearProxyLikelihood(coefficient_prior=&lt;numpyro.distributions.continuous.HalfNormal object at 0x7f5570e5c750 with batch shape () and event shape ()&gt;,
                      effect_name='latent/awareness',
                      reference_df=            latent/awareness
2001-07-26          0.925163
2004-05-15          0.842808
2002-11-06          0.076063
2002-12-31          0.079602
2002-03-06          0.744027
...                      ...
2004-10-21          0.351357
2004-05-23          0.813127
2000-05-29          0.914647
2003-06-26          0.040826
2001-03-17          0.791952

[180 rows x 1 columns])</pre></div></div></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><label>inference_engine</label></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="UUID('c3f9ffac-9c15-4d7c-bc0a-49ce18353fea')" type="checkbox"><label for="UUID('c3f9ffac-9c15-4d7c-bc0a-49ce18353fea')" class="sk-toggleable__label sk-toggleable__label-arrow">MAPInferenceEngine</label><div class="sk-toggleable__content"><pre>MAPInferenceEngine(num_steps=5000,
                   optimizer=LBFGSSolver(max_linesearch_steps=300,
                                         memory_size=300))</pre></div></div></div></div></div></div></div></div></div></div>
</div>
</div>
<p>Let‚Äôs visualize the predictions of this proxy variable model:</p>
<div id="b3e32825" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>y_pred_model <span class="op">=</span> model.predict(X<span class="op">=</span>X, fh<span class="op">=</span>X.index)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>y.plot(label<span class="op">=</span><span class="st">"Observed"</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>y_pred_model.plot(label<span class="op">=</span><span class="st">"Predicted"</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"In-Sample Forecast: Observed vs Predicted"</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="proxy_variables_files/figure-html/cell-14-output-1.png" width="662" height="357" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p><em>Component-Level Diagnostics</em></p>
<p>With <code>predict_components</code>, we can obtain the model‚Äôs components.</p>
<div id="c18b3a33" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>y_pred_components <span class="op">=</span> model.predict_components(X<span class="op">=</span>X, fh<span class="op">=</span>X.index)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>In a real use-casee, you would not have access to the ground truth of the components. We use them here to show how the model behaves, and how incorporing extra information can improve it.</p>
<div id="c337dea1" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">5</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">12</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, name <span class="kw">in</span> <span class="bu">enumerate</span>(</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"trend"</span>,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"yearly_seasonality"</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"latent/awareness"</span>,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"awareness_to_sales"</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"last_click_spend"</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    true_effect[name].plot(ax<span class="op">=</span>axs[i], label<span class="op">=</span><span class="st">"True"</span>, color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    y_pred_components[name].plot(ax<span class="op">=</span>axs[i], label<span class="op">=</span><span class="st">"Estimated"</span>)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    axs[i].set_title(name)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    axs[i].legend()</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="proxy_variables_files/figure-html/cell-16-output-1.png" width="758" height="1142" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="comparing-models" class="level2">
<h2 class="anchored" data-anchor-id="comparing-models">3. Comparing models</h2>
<p>Here, we do our final comparison of the models, looking at the counterfactual impact of zeroing out the awareness ad spend. This shows how important it is to include the proxy variable to correctly attribute the impact of awareness spend.</p>
<div id="046bafad" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_compare_models(column):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    delta_true <span class="op">=</span> get_counterfactual(true_model, X, column)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    delta_baseline <span class="op">=</span> get_counterfactual(baseline_model, X, column)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    delta_proxy <span class="op">=</span> get_counterfactual(model, X, column)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    delta_true.plot(label<span class="op">=</span><span class="st">"True Effect"</span>, color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    delta_baseline.plot(label<span class="op">=</span><span class="st">"Baseline Model"</span>)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    delta_proxy.plot(label<span class="op">=</span><span class="st">"Proxy Variable Model"</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f"Estimated Effect of Awareness Spend"</span>)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"Sales Lift"</span>)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="st">"compare_models_awareness_effect.png"</span>, dpi<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>plot_compare_models(<span class="st">"ad_spend_awareness"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="proxy_variables_files/figure-html/cell-17-output-1.png" width="758" height="374" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We see that, although not perfect, the model with the proxy variable is able to much better capture the true impact of awareness spend on sales, while the baseline model without the proxy variable fails to do so.</p>
</section>
<section id="how-to-cite-this-package" class="level2">
<h2 class="anchored" data-anchor-id="how-to-cite-this-package">How to cite this package</h2>
<p>If you use Prophetverse or any of this idea in your package/paper, please cite this package according to DOI on Readme.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "Óßã";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>